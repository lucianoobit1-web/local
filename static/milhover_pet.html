<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT BURGER HOUSE</title>
    <link rel="icon" type="image/png" href="logo_empresa.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- INICIO: LIBRERÍAS PARA GRÁFICOS Y PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- NUEVA LIBRERÍA PARA LEER EXCEL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- FIN: LIBRERÍAS -->
    <style>
    :root {
        /* --- Nueva Paleta Clara (Verde) --- */
        --color-bg: #F8F9FA; /* Fondo gris muy claro */
        --color-surface: #FFFFFF; /* Superficie (tarjetas) - blanco */
        --color-surface-light: #F0F2F5; /* Gris un poco más claro para hovers/paneles */
        --color-border: #DEE2E6; /* Borde gris claro */

        /* --- Colores para el Texto --- */
        --color-text-primary: #212529; /* Texto principal - negro/gris oscuro */
        --color-text-secondary: #495057; /* Texto secundario - gris oscuro */
        --color-text-muted: #6C757D; /* Texto más apagado - gris medio */

        /* --- Acentos y Botones (Verde #6FAE46) --- */
        --color-accent: #6FAE46; /* Color de acento: Verde */
        --color-accent-dark: #5a9a3a; /* Versión más oscura para hover */
        --color-accent-glow: rgba(111, 174, 70, 0.3); /* Resplandor verde */
        
        /* --- Otros colores que se mantienen o ajustan --- */
        --color-danger: #f43f5e; /* Rojo para peligro (se mantiene) */
        --color-danger-dark: #e11d48;
        --color-danger-glow: rgba(244, 63, 94, 0.4);
        --color-secondary-action: #E9ECEF; /* Botón secundario (gris claro) */
        --color-secondary-action-dark: #DEE2E6; /* Hover del botón secundario */
        --color-info: var(--color-surface);
        --color-warning: #f59e0b; /* Amarillo (se mantiene) */
    }

    /* --- INICIO: Parche para Tema Claro (Corregir texto blanco) --- */
    
    /* Sobrescribe clases de título y texto principal */
    .text-white {
        color: var(--color-text-primary) !important;
    }

    /* Sobrescribe clases de texto secundario */
    .text-gray-300 {
        color: var(--color-text-secondary) !important;
    }
    
    /* Sobrescribe clases de texto "apagado" */
    .text-gray-400,
    .text-gray-500 {
        color: var(--color-text-muted) !important;
    }
    
    /* Arregla el color de texto de todos los <select> */
    select {
         color: var(--color-text-primary) !important;
    }
    /* --- FIN: Parche para Tema Claro --- */

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--color-bg);
        color: var(--color-text-secondary);
        transition: padding 0.3s ease-in-out;
    }

    /* Estilo para centrar el frame de login */
    body:has(#loginFrame.active) {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    /* --- INICIO: Bloque para unificar colores --- */
.bg-gray-900 {
    background-color: var(--color-surface) !important; /* Fondo principal casi negro */
}

.bg-gray-800 {
    background-color: var(--color-surface-light) !important; /* Fondo de las tarjetas y paneles */
}

.border-gray-700 {
    border-color: var(--color-border) !important; /* Borde dorado oscuro para las tarjetas */
}

.bg-gray-700, .bg-gray-700 select {
     background-color: var(--color-surface) !important; /* Para selectores y otros fondos */
     border-color: var(--color-border) !important;
}

#gastosTotalesLabel {
    color: var(--color-text-secondary) !important; /* Asegura que el texto sea legible */
}
/* --- FIN: Bloque para unificar colores --- */

/* --- INICIO: Bloque para alinear columnas de Pedidos --- */
#pedidosTableBody td:nth-child(3),
#pedidosTableBody td:nth-child(4) {
    text-align: left !important; /* Alinea el texto a la izquierda */
}
/* --- FIN: Bloque para alinear columnas de Pedidos --- */
    
    /* ------------------------- */
    /* --- SIDEBAR --- */
    /* ------------------------- */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 260px;
        height: 100vh;
        background-color: var(--color-bg);
        border-right: 1px solid var(--color-border);
        color: var(--color-text-primary);
        display: flex;
        flex-direction: column;
        z-index: 500;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
    }
    .sidebar.visible {
        transform: translateX(0);
    }
    .sidebar-header {
        text-align: center;
        padding: 1.5rem 1rem;
        border-bottom: 1px solid var(--color-border);
    }
    .sidebar-logo {
        max-width: 150px;
        margin: 0 auto 0.75rem;
    }
    .sidebar-link {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        padding: 1rem 1.5rem;
        color: var(--color-text-secondary);
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s, border-left-color 0.2s;
        border-left: 4px solid transparent;
        font-size: 0.95rem;
    }
    .sidebar-link:hover {
        background-color: var(--color-surface);
        color: var(--color-text-primary);
    }
    .sidebar-link.active {
        background-color: var(--color-surface);
        color: var(--color-accent);
        font-weight: 700;
        border-left-color: var(--color-accent);
    }
    .sidebar-icon {
        width: 1.5rem;
        height: 1.5rem;
        flex-shrink: 0;
    }
    .sidebar-logout {
        margin-top: auto;
        border-top: 1px solid var(--color-border);
    }
    #appContainer.sidebar-active {
        margin-left: 260px;
        width: calc(100% - 260px);
        max-width: none;
        height: 100vh;
        overflow-y: auto;
        border-radius: 0;
    }

    /* ------------------------- */
    /* --- BOTONES --- */
    /* ------------------------- */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .btn:hover {
        transform: translateY(-2px);
    }
    .btn-primary {
        background-color: var(--color-accent);
        color: white;
    }
    .btn-primary:hover {
        background-color: var(--color-accent-dark);
        box-shadow: 0 4px 20px var(--color-accent-glow);
    }
    .btn-danger {
        background-color: var(--color-danger);
        color: #FFFFFF; /* Aseguramos que el texto sea blanco */
    }
    .btn-danger:hover {
        background-color: var(--color-danger-dark);
        box-shadow: 0 4px 20px var(--color-danger-glow);
    }
    .btn-secondary {
        background-color: var(--color-secondary-action);
        color: var(--color-text-primary);
    }
    .btn-secondary:hover {
        background-color: var(--color-secondary-action-dark);
    }
    
    /* ------------------------- */
    /* --- TABLAS --- */
    /* ------------------------- */
    .table-header-cell {
        padding: 1rem 1.25rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background-color: var(--color-surface-light);
        color: var(--color-text-primary);
        border-bottom: 2px solid var(--color-accent);
    }
    .table-cell {
        padding: 1rem 1.25rem;
        text-align: left;
        border-bottom: 1px solid var(--color-surface-light);
    }
    .table-row:hover {
        background-color: var(--color-surface-light);
    }
    .selected-row {
        background-color: var(--color-accent-glow) !important;
        color: var(--color-text-primary);
    }
    
    /* ------------------------- */
    /* --- FORMULARIOS --- */
    /* ------------------------- */
    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="email"],
    select {
        width: 100%;
        padding: 0.75rem 1rem;
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 0.5rem;
        color: var(--color-text-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus,
    select:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px var(--color-accent-glow);
    }
    label {
        color: var(--color-text-secondary);
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    /* ------------------------- */
    /* --- MODALES Y NOTIFICACIONES --- */
    /* ------------------------- */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(10, 10, 10, 0.7);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .custom-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .custom-modal-content {
        background-color: var(--color-surface);
        padding: 2rem;
        border-radius: 1rem;
        border: 1px solid var(--color-border);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        text-align: center;
        max-width: 450px;
        width: 90%;
        transform: translateY(-30px);
        transition: transform 0.3s ease;
    }
    .custom-modal-overlay.show .custom-modal-content {
        transform: translateY(0);
    }
    .custom-modal-content h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 1rem;
    }
    .custom-modal-content p {
        font-size: 1rem;
        color: var(--color-text-secondary);
        margin-bottom: 1.5rem;
        white-space: pre-wrap;
    }
    .custom-modal-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }
    .custom-modal-buttons button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .custom-modal-buttons .confirm-btn {
        background-color: var(--color-accent);
        color: #FFFFFF; /* Forzamos el texto a blanco para que contraste con el verde */
    }
    .custom-modal-buttons .confirm-btn:hover {
        background-color: var(--color-accent-dark);
    }
    .custom-modal-buttons .cancel-btn {
        background-color: var(--color-surface-light);
        color: var(--color-text-primary);
    }
     .custom-modal-buttons .cancel-btn:hover {
        background-color: var(--color-border);
    }

    /* ------------------------- */
    /* --- UTILIDADES Y OTROS --- */
    /* ------------------------- */
    .app-frame {
        display: none;
    }
    .app-frame.active {
        display: block;
    }
    .status-dot {
        height: 1rem;
        width: 1rem;
        border-radius: 50%;
        display: inline-block;
        margin: 0 auto;
    }
    .status-dot.yellow { background-color: var(--color-warning); }
    .status-dot.green { background-color: var(--color-accent); }
    .status-dot.red { background-color: var(--color-danger); }

    /* Alineación de celdas específicas */
    #ingresosTableBody td,
    #trabajosTableBody td,
    #clientesTableBody td,
    #gastosTableBody td {
        text-align: center !important;
    }
    #inventarioTableBody td,
    #listaPreciosTableBody td,
    #proveedoresTableBody td {
        text-align: left !important;
    }
    /* Alineación específica para columnas de proveedores (AJUSTADO) */
#proveedoresTableBody td:nth-child(4), /* Costo */
#proveedoresTableBody td:nth-child(5), /* Porcentaje */
#proveedoresTableBody td:nth-child(6) { /* Precio Final */
    text-align: right !important;
}
    #listaPreciosTableBody td:nth-child(2) {
        text-align: left !important;
    }
    </style>
</head>
<body class="p-0">

    <!-- Sidebar se genera dinámicamente -->
    <div id="sidebar" class="sidebar"></div>
    
    <!-- Modal genérico -->
    <div id="customModalOverlay" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div id="modalInputContainer" class="mb-4 hidden">
                <input type="text" id="modalInput" />
            </div>
            <div class="custom-modal-buttons">
                <button id="modalConfirmBtn" class="confirm-btn">Aceptar</button>
                <button id="modalCancelBtn" class="cancel-btn hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Contenedor principal de la aplicación -->
    <div id="appContainer" class="bg-gray-900 p-4 sm:p-6 md:p-8 w-full">

        <!-- FRAME: Login -->
        <div id="loginFrame" class="app-frame active">
            <div class="flex flex-col items-center justify-center bg-gray-800 bg-opacity-50 p-8 rounded-2xl border border-gray-700 max-w-md mx-auto">
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="mb-8 h-40" onerror="this.onerror=null;this.src='https://placehold.co/200x100/1f2937/f9fafb?text=Logo';">
                <h1 class="text-4xl font-bold text-white mb-8 text-center">Bienvenido</h1>
                <div class="mb-5 w-full">
                    <label for="loginUsername">Usuario:</label>
                    <input type="text" id="loginUsername" placeholder="Tu usuario">
                </div>
                <div class="mb-7 w-full">
                    <label for="loginPassword">Contraseña:</label>

                    <input type="password" id="loginPassword" placeholder="">
                </div>
                <button id="loginBtn" class="w-full btn btn-primary text-lg">
                    Iniciar Sesión
                </button>
            </div>
        </div>

        <!-- FRAME: Dashboard de Inicio -->
        <div id="inicioFrame" class="app-frame">
            <div class="flex items-center justify-between mb-8">
                <h2 id="welcomePhraseText" class="text-3xl font-bold text-white">¡Bienvenido/a!</h2>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/150x60/111827/ffffff?text=Logo';">
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center mb-8 gap-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
                <label for="dashboardMonthSelector" class="text-white">Mes:</label>
                <select id="dashboardMonthSelector" class="bg-gray-700 text-white rounded px-3 py-2"></select>
                <label for="dashboardYearSelector" class="text-white">Año:</label>
                <select id="dashboardYearSelector" class="bg-gray-700 text-white rounded px-3 py-2"></select>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="space-y-6">
                    <div id="inicioAlertaStockBox" class="p-4 border-l-4 hidden" style="border-color: var(--color-danger); background-color: var(--color-surface-light); border-radius: 0.5rem;">
                        <h4 class="font-bold text-lg" style="color: var(--color-danger);">¡Alerta: Stock Bajo!</h4>
                        <p class="text-sm text-gray-300 mb-2">Los siguientes productos tienen stock bajo o cero:</p>
                        <ul id="inicioAlertaStockLista" class="list-disc list-inside text-gray-300 space-y-1 text-sm">
                            </ul>
                    </div>

                    <div id="inicioAlertaVencimientoBox" class="p-4 border-l-4 hidden" style="border-color: var(--color-warning); background-color: var(--color-surface-light); border-radius: 0.5rem;">
                        <h4 class="font-bold text-lg" style="color: var(--color-warning);">¡Alerta de Vencimiento!</h4>
                        <p class="text-sm text-gray-300 mb-2">Productos que vencen en menos de 2 meses:</p>
                        <ul id="inicioAlertaVencimientoLista" class="list-disc list-inside text-gray-300 space-y-1 text-sm">
                            </ul>
                    </div>

                    <div id="inicioAlertaVencidosBox" class="p-4 border-l-4 hidden" style="border-color: var(--color-danger); background-color: var(--color-surface-light); border-radius: 0.5rem;">
                        <h4 class="font-bold text-lg" style="color: var(--color-danger);">¡Alerta: Producto Vencido!</h4>
                        <p class="text-sm text-gray-300 mb-2">Productos que han superado su fecha de vencimiento:</p>
                        <ul id="inicioAlertaVencidosLista" class="list-disc list-inside text-gray-300 space-y-1 text-sm">
                            </ul>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                        <h3 id="resumenTitleEl" class="text-xl font-bold text-white mb-4">Resumen del Mes</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Ingresos Totales (Ventas):</span>
                                <span id="monthlyIncome" class="text-lg font-bold text-green-400">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Costo Total (Mercadería):</span>
                                <span id="monthlyCost" class="text-lg font-bold text-orange-400">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Gastos Totales (Pagados):</span>
                                <span id="monthlyExpenses" class="text-lg font-bold text-rose-400">$0.00</span>
                            </div>
                            <hr class="border-gray-700 my-2">
                            <div class="flex justify-between items-center">
                                <span class="text-white font-bold text-xl">Balance del Mes:</span>
                                <span id="monthlyBalance" class="text-2xl font-bold text-white">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                        <h3 id="gananciaTitleEl" class="text-xl font-bold text-white mb-4">Total Vendido por Producto</h3>
                        <div id="dashboardRubros" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FRAME: Dashboard de Inicio LIMITADO -->
       <div id="inicioLimitadoFrame" class="app-frame"> <div class="flex items-center justify-between mb-8">
                <h2 id="welcomePhraseTextLimitado" class="text-3xl font-bold text-white">¡Bienvenido/a!</h2> <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/150x60/111827/ffffff?text=Logo';">
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center mb-8 gap-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
                <label for="dashboardMonthSelectorLimitado" class="text-white">Mes:</label>
                <select id="dashboardMonthSelectorLimitado" class="bg-gray-700 text-white rounded px-3 py-2"></select>
                <label for="dashboardYearSelectorLimitado" class="text-white">Año:</label>
                <select id="dashboardYearSelectorLimitado" class="bg-gray-700 text-white rounded px-3 py-2"></select>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="space-y-6">
                    <div id="inicioAlertaStockBoxLimitado" class="p-4 border-l-4 hidden" style="border-color: var(--color-danger); background-color: var(--color-surface-light); border-radius: 0.5rem;">
                        <h4 class="font-bold text-lg" style="color: var(--color-danger);">¡Alerta: Stock Bajo!</h4>
                        <p class="text-sm text-gray-300 mb-2">Los siguientes productos tienen stock bajo o cero:</p>
                        <ul id="inicioAlertaStockListaLimitado" class="list-disc list-inside text-gray-300 space-y-1 text-sm"></ul>
                    </div>
                    <div id="inicioAlertaVencimientoBoxLimitado" class="p-4 border-l-4 hidden" style="border-color: var(--color-warning); background-color: var(--color-surface-light); border-radius: 0.5rem;">
                        <h4 class="font-bold text-lg" style="color: var(--color-warning);">¡Alerta de Vencimiento!</h4>
                        <p class="text-sm text-gray-300 mb-2">Productos que vencen en menos de 2 meses:</p>
                        <ul id="inicioAlertaVencimientoListaLimitado" class="list-disc list-inside text-gray-300 space-y-1 text-sm"></ul>
                    </div>
                    <div id="inicioAlertaVencidosBoxLimitado" class="p-4 border-l-4 hidden" style="border-color: var(--color-danger); background-color: var(--color-surface-light); border-radius: 0.5rem;">
                        <h4 class="font-bold text-lg" style="color: var(--color-danger);">¡Alerta: Producto Vencido!</h4>
                        <p class="text-sm text-gray-300 mb-2">Productos que han superado su fecha de vencimiento:</p>
                        <ul id="inicioAlertaVencidosListaLimitado" class="list-disc list-inside text-gray-300 space-y-1 text-sm"></ul>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Noticias y Promociones</h3>
                        <div id="dashboardNoticiasLimitado" class="space-y-3 text-gray-300 text-sm">
                            <p><strong>¡Nueva promo!</strong> Llevando 2 bolsas de alimento balanceado, tenés 15% de descuento en la segunda unidad.</p>
                            <hr class="border-gray-700 my-2">
                            <p>Recordatorio: El próximo Lunes abrimos en horario reducido de 9:00 a 13:00 hs.</p>
                            </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                        <h3 id="gananciaTitleElLimitado" class="text-xl font-bold text-white mb-4">Total Vendido por Producto</h3>
                        <div id="dashboardRubrosLimitado" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FRAME: FIN INICIO ROL LIMITADO -->
        
        <!-- FRAME: Gestión de Gastos -->
        <div id="gastosFrame" class="app-frame">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-white">Gestión de Gastos</h1>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
            </div>
            <div class="flex flex-col md:flex-row items-center justify-center mb-8 gap-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
                <label for="gastosMonthSelector">Mes:</label>
                <select id="gastosMonthSelector"></select>
                <label for="gastosYearSelector">Año:</label>
                <select id="gastosYearSelector"></select>
            </div>
            <div class="text-center mb-8 p-4 rounded-xl bg-gray-800 border border-gray-700">
                <p id="gastosTotalesLabel" class="text-lg font-semibold text-white">Totales: $0.00 | Pagado: $0.00 | Pendiente: $0.00</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button id="gastosAddConceptoBtn" class="btn btn-primary">Agregar Concepto</button>
                <button id="gastosEliminarSeleccionadosBtn" class="btn btn-danger">Eliminar Seleccionados</button>
                <button id="gastosEliminarMontosBtn" class="btn btn-secondary">Eliminar Todos los Montos</button>
                <button id="gastosExportarBtn" class="btn btn-secondary">Exportar</button>
            </div>
            <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
                <table class="min-w-full">
                    <thead></thead>
                    <tbody id="gastosTableBody"></tbody>
                </table>
                <div id="gastosNoConceptosMessage" class="p-6 text-center text-gray-400 hidden">
                    No hay conceptos de gastos para el mes seleccionado.
                </div>
            </div>
        </div>

        <!-- FRAME: Balance de Cuenta (antes Ingresos) -->
<div id="ingresosFrame" class="app-frame">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">Balance de Cuenta</h1>
        <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
    </div>

    <div class="text-center mb-8 p-6 rounded-xl bg-gray-800 border border-gray-700">
        <p class="text-lg font-semibold text-white">Balance Total:</p>
        <p id="balanceTotalMonto" class="text-4xl font-bold" style="color: var(--color-accent);">$0.00</p>
    </div>

    <div class="flex flex-col md:flex-row items-center justify-center mb-8 gap-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
        <label for="ingresosMonthSelector" class="text-white">Mes:</label>
        <select id="ingresosMonthSelector" class="bg-gray-700 text-white rounded px-3 py-2"></select>
        <label for="ingresosYearSelector" class="text-white">Año:</label>
        <select id="ingresosYearSelector" class="bg-gray-700 text-white rounded px-3 py-2"></select>
    </div>

    <!-- Formulario para agregar movimiento manual -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 p-6 bg-gray-800 border border-gray-700 rounded-xl items-end">
        <div>
            <label for="balanceImporteInput">Importe:</label>
            <input type="number" id="balanceImporteInput" placeholder="Ej: 500.00">
        </div>
        <div>
            <label for="balanceTipoSelect">Tipo:</label>
            <select id="balanceTipoSelect">
                <option value="ingreso">Ingreso</option>
                <option value="egreso">Egreso</option>
            </select>
        </div>
        <div>
            <label for="balanceConceptoInput">Concepto:</label>
            <input type="text" id="balanceConceptoInput" placeholder="Ej: Venta manual">
        </div>
        <button id="balanceAddBtn" class="btn btn-primary w-full">Agregar Movimiento</button>
    </div>

    <div class="flex justify-end mb-8">
         <button id="balanceDeleteBtn" class="btn btn-danger">Eliminar Movimiento Manual</button>
    </div>

    <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
        <table class="min-w-full">
            <thead>
                <tr>
                    <th class="table-header-cell rounded-tl-xl">Fecha</th>
                    <th class="table-header-cell">Concepto</th>
                    <th class="table-header-cell">Tipo</th>
                    <th class="table-header-cell rounded-tr-xl">Importe</th>
                </tr>
            </thead>
            <tbody id="balanceTableBody"></tbody>
        </table>
        <div id="balanceNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
            No hay movimientos registrados.
        </div>
    </div>
</div>
<!-- FIN FRAME: Balance de Cuenta -->

        <!-- FRAME: Lista de Precios -->
        <div id="listaPreciosFrame" class="app-frame">
            <div class="flex justify-between items-center mb-8">
                <h1 id="listaPreciosTitle" class="text-3xl font-bold text-white">Lista de Precios</h1>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
            </div>
            <div class="flex flex-col md:flex-row items-center justify-center mb-8 gap-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
                <label for="listaPreciosMonthSelector">Mes:</label>
                <select id="listaPreciosMonthSelector"></select>
                <label for="listaPreciosYearSelector">Año:</label>
                <select id="listaPreciosYearSelector"></select>
            </div>
            <div class="mb-6">
                <label for="listaPreciosSearchInput" class="text-white">Buscar (Código o Descripción):</label>
                <input type="text" id="listaPreciosSearchInput" placeholder="Escriba para buscar...">
            </div>
            <div class="flex flex-col md:flex-row gap-6 mb-8">
                <div class="flex-1">
                  <label for="listaPreciosConceptoSelector">Filtrar por Concepto:</label>
                  <select id="listaPreciosConceptoSelector">
                    <option value="">Mostrar todo</option>
                  </select>
                </div>
                <div class="flex-1">
                  <label for="listaPreciosTituloSelector">Filtrar por Título:</label>
                  <select id="listaPreciosTituloSelector">
                    <option value="">Mostrar todo</option>
                  </select>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <button id="listaPreciosAddBtn" class="btn btn-primary">Agregar</button>
                <button id="listaPreciosEditBtn" class="btn btn-secondary">Editar</button>
                <button id="listaPreciosDeleteBtn" class="btn btn-danger">Eliminar</button>
                <button id="listaPreciosPorcentajeBtn" class="btn btn-secondary">% Sumar a Precios</button>
                <button id="listaPreciosPDFBtn" class="btn btn-secondary">Generar PDF</button>
            </div>
            <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="table-header-cell rounded-tl-xl text-left">Código</th>
                            <th class="table-header-cell text-left">Descripción</th>
                            <th class="table-header-cell rounded-tr-xl text-left">Precio</th>
                        </tr>
                    </thead>
                    <tbody id="listaPreciosTableBody"></tbody>
                </table>
                <div id="listaPreciosNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
                    No hay ítems en la lista de precios para el mes seleccionado.
                </div>
            </div>
            <p class="text-sm italic text-gray-500 mt-6 text-center">Los precios no incluyen el IVA 21%</p>
        </div>
        
       <div id="costosFrame" class="app-frame">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-white">Gestión de Costos</h1>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
            </div>

            <div class="mb-6">
                <label for="costosSearchInput" class="text-white">Buscar (Código o Descripción):</label>
                <input type="text" id="costosSearchInput" placeholder="Escriba para buscar...">
            </div>

            <div class="flex justify-end gap-4 mb-8"> <button id="costosEditBtn" class="btn btn-secondary">Editar Costo</button>
                 <button id="costosPercentBtn" class="btn btn-primary">Establecer % Ganancia</button> 
            </div>

            <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="table-header-cell rounded-tl-xl text-left">Código</th>
                            <th class="table-header-cell text-left">Descripción</th>
                            <th class="table-header-cell text-left">Costo</th>
                            <th class="table-header-cell rounded-tr-xl text-left">% Ganancia</th>
                        </tr>
                    </thead>
                    <tbody id="costosTableBody"></tbody>
                </table>
                <div id="costosNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
                    No hay ítems cargados. Los ítems aparecen aquí después de agregarlos en la Lista de Precios.
                </div>
            </div>
        </div>

        

        <!-- INICIO: NUEVO FRAME DE STOCK -->
        <div id="stockFrame" class="app-frame">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-white">Gestión de Stock</h1>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <button id="stockAddBtn" class="btn btn-primary">Agregar</button>
                <button id="stockEditBtn" class="btn btn-secondary">Editar</button>
                <button id="stockDeleteBtn" class="btn btn-danger">Eliminar</button>
            </div>

            <div class="mb-6">
                <label for="stockSearchInput" class="text-white">Buscar (Código o Descripción):</label>
                <input type="text" id="stockSearchInput" placeholder="Escriba para buscar...">
            </div>
            <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="table-header-cell rounded-tl-xl text-left">Código</th>
                            <th class="table-header-cell text-left">Descripción</th>
                            <th class="table-header-cell rounded-tr-xl text-left">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
                <div id="stockNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
                    No hay productos en el stock.
                </div>
            </div>
        </div>
        <!-- FIN: NUEVO FRAME DE STOCK -->

        <!-- INICIO: NUEVO FRAME DE PEDIDOS -->
<div id="pedidosFrame" class="app-frame">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">Gestión de Ventas</h1>
        <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
    </div>
    <div class="flex flex-col md:flex-row items-center justify-center mb-8 gap-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
        <label for="pedidosMonthSelector" class="text-white">Mes:</label>
        <select id="pedidosMonthSelector" class="bg-gray-700 text-white rounded px-3 py-2"></select>
        <label for="pedidosYearSelector" class="text-white">Año:</label>
        <select id="pedidosYearSelector" class="bg-gray-700 text-white rounded px-3 py-2"></select>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <button id="pedidosAddBtn" class="btn btn-primary">Agregar Venta</button>
        <button id="pedidosEditBtn" class="btn btn-secondary">Editar Venta</button>
        <button id="pedidosDeleteBtn" class="btn btn-danger">Eliminar Venta</button>
    </div>
    <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
        <table class="min-w-full">
            <thead>
                <tr>
                    <th class="table-header-cell rounded-tl-xl">Pedido</th>
                    <th class="table-header-cell">Monto Total</th>
                    <th class="table-header-cell">Dirección</th>
                    <th class="table-header-cell">Observación</th>
                </tr>
            </thead>
            <tbody id="pedidosTableBody"></tbody>
        </table>
        <div id="pedidosNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
            No hay pedidos registrados.
        </div>
    </div>
</div>
<!-- FIN: NUEVO FRAME DE PEDIDOS -->

<!-- INICIO: MODAL PARA AGREGAR/EDITAR PEDIDO -->
<div id="pedidosModal" class="custom-modal-overlay">
    <div class="custom-modal-content max-w-2xl">
        <h3 id="pedidosModalTitle">Agregar Pedido</h3>
        <div class="space-y-4 text-left mt-6">
            <div>
                <label>Items del Pedido:</label>
                <div class="flex items-center gap-2 mb-2">
                    <select id="pedidosAddItemSelect" class="flex-grow"></select>
                    <button id="pedidosAddItemBtn" class="btn btn-secondary py-2 px-3">Añadir</button>
                </div>
                <div id="pedidosItemsList" class="p-3 bg-gray-900 rounded-lg min-h-[100px] max-h-48 overflow-y-auto">
                </div>
                <p class="text-right font-bold mt-2">Monto Total: <span id="pedidosMontoTotal" style="color: var(--color-accent);"></span></p>
            </div>
            <div>
                <label for="pedidosDireccionInput">Dirección:</label>
                <input type="text" id="pedidosDireccionInput" list="clientes-list" placeholder="Ej: Av. Rivadavia 1234">
        <datalist id="clientes-list"></datalist>
            </div>
            <div>
                <label for="pedidosObservacionInput">Observación:</label>
                <input type="text" id="pedidosObservacionInput" placeholder="Ej: Sin aderezo">
            </div>
        </div>
        <div class="custom-modal-buttons mt-6">
            <button id="pedidosModalConfirmBtn" class="confirm-btn">Guardar</button>
            <button id="pedidosModalCancelBtn" class="cancel-btn">Cancelar</button>
        </div>
    </div>
</div>
<!-- FIN: MODAL PARA AGREGAR/EDITAR PEDIDO -->

<!-- INICIO: NUEVO FRAME DE VENCIMIENTOS-->
<div id="vencimientosFrame" class="app-frame">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-white">Gestión de Vencimientos</h1>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <button id="vencimientosAddBtn" class="btn btn-primary">Agregar</button>
                <button id="vencimientosEditBtn" class="btn btn-secondary">Editar</button>
                <button id="vencimientosDeleteBtn" class="btn btn-danger">Eliminar</button>
            </div>

            <div class="mb-6">
                <label for="vencimientosSearchInput" class="text-white">Buscar (Código o Descripción):</label>
                <input type="text" id="vencimientosSearchInput" placeholder="Escriba para buscar...">
            </div>

            <div id="vencimientosAlertaBox" class="mb-6 p-4 border-l-4 hidden" style="border-color: var(--color-warning); background-color: var(--color-surface-light);">
                <h4 class="font-bold text-lg" style="color: var(--color-warning);">¡Alerta de Vencimiento!</h4>
                <p class="text-sm text-gray-300 mb-2">Los siguientes productos vencen en menos de 2 meses:</p>
                <ul id="vencimientosAlertaLista" class="list-disc list-inside text-gray-300 space-y-1">
                    </ul>
            </div>

            <div id="vencimientosVencidosAlertaBox" class="mb-6 p-4 border-l-4 hidden" style="border-color: var(--color-danger); background-color: var(--color-surface-light);">
                <h4 class="font-bold text-lg" style="color: var(--color-danger);">¡Alerta: Producto Vencido!</h4>
                <p class="text-sm text-gray-300 mb-2">Los siguientes productos han superado su fecha de vencimiento:</p>
                <ul id="vencimientosVencidosAlertaLista" class="list-disc list-inside text-gray-300 space-y-1">
                    </ul>
            </div>

            <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="table-header-cell rounded-tl-xl text-left">Código</th>
                            <th class="table-header-cell text-left">Descripción</th>
                            <th class="table-header-cell rounded-tr-xl text-left">Vencimiento</th>
                        </tr>
                    </thead>
                    <tbody id="vencimientosTableBody"></tbody>
                </table>
                <div id="vencimientosNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
                    No hay productos cargados en vencimientos.
                </div>
            </div>
        </div>
<!-- FIN VENCIMIENTOS -->

<!-- INICIO: FRAME DE PROVEEDORES -->
<div id="proveedoresFrame" class="app-frame">
    <!-- INICIO: NUEVO BUSCADOR -->
<div class="mb-6">
    <label for="proveedoresSearchInput" class="text-white">Buscar (Proveedor, Código o Descripción):</label>
    <input type="text" id="proveedoresSearchInput" placeholder="Escriba para buscar...">
</div>
<!-- FIN: NUEVO BUSCADOR -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">Gestión de Proveedores</h1>
        <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <!-- Este es el input real, pero lo ocultamos -->
        <input type="file" id="proveedoresExcelInput" class="hidden" accept=".xlsx, .xls">

        <!-- Este 'label' parece un botón y activa el input de arriba -->
        <label for="proveedoresExcelInput" class="btn btn-primary cursor-pointer">
            Cargar Lista (Excel)
        </label>

        <!-- Este botón guardará los datos cargados -->
        <button id="proveedoresGuardarBtn" class="btn btn-secondary">Guardar Cambios</button>
    </div>

    <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700">
        <table class="min-w-full">
            <thead>
                <tr>
                    <th class="table-header-cell rounded-tl-xl text-left">Proveedor</th>
                    <th class="table-header-cell text-left">Código</th>
                    <th class="table-header-cell text-left">Descripción</th>
                    <th class="table-header-cell text-right">Costo</th>
                    <th class="table-header-cell text-right">Porcentaje (%)</th>
                    <th class="table-header-cell rounded-tr-xl text-right">Precio Final</th>
                </tr>
            </thead>
            <tbody id="proveedoresTableBody">
                <!-- Las filas se generarán con JavaScript -->
            </tbody>
        </table>
        <div id="proveedoresNoItemsMessage" class="p-6 text-center text-gray-400 hidden">
            No hay datos de proveedores. Cargue un archivo de Excel para comenzar.
        </div>
    </div>
</div>
<!-- FIN: FRAME DE PROVEEDORES -->

<div id="costosEditModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="costosEditModalTitle">Editar Costo</h3>
                 <div class="space-y-4 text-left">
                    <div>
                        <label>Producto:</label>
                        <input type="text" id="costosEditInfo" disabled class="bg-gray-700">
                    </div>
                    <div>
                        <label for="costosEditInput">Costo ($):</label>
                        <input type="number" id="costosEditInput" placeholder="Ingrese el costo unitario">
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="costosEditModalConfirmBtn" class="confirm-btn">Guardar Costo</button>
                    <button id="costosEditModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>


        <div id="costosPercentModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3>Establecer % Ganancia</h3>
                 <div class="space-y-4 text-left">
                    <div>
                        <label>Producto:</label>
                        <input type="text" id="costosPercentInfo" disabled class="bg-gray-700">
                    </div>
                    <div>
                        <label>Costo Actual:</label>
                        <input type="text" id="costosPercentCostoActual" disabled class="bg-gray-700">
                    </div>
                    <div>
                        <label for="costosPercentInput">% Ganancia Deseado:</label>
                        <input type="number" id="costosPercentInput" placeholder="Ej: 50 para 50%">
                    </div>
                     <div>
                        <label>Precio Calculado:</label>
                        <input type="text" id="costosPercentPrecioCalculado" disabled class="bg-gray-700">
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="costosPercentModalConfirmBtn" class="confirm-btn">Guardar Precio</button>
                    <button id="costosPercentModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>
    


        <!-- MODAL: Agregar Item a Lista de Precios -->
        <div id="listaPreciosAddModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="listaPreciosAddModalTitle">Agregar Elemento</h3>
                <div class="space-y-4 text-left">
                    <div>
                        <label for="listaPreciosAddTipoSelect">Tipo de Elemento:</label>
                        <select id="listaPreciosAddTipoSelect">
                            <option value="concepto">Concepto</option>
                            <option value="titulo">Título</option>
                            <option value="item">Item</option>
                        </select>
                    </div>
                    <div>
                        <label for="listaPreciosAddDescripcionInput">Descripción:</label>
                        <input type="text" id="listaPreciosAddDescripcionInput">
                    </div>
                    <div class="hidden" id="listaPreciosAddCodigoGroup">
                        <label for="listaPreciosAddCodigoInput">Código:</label>
                        <input type="text" id="listaPreciosAddCodigoInput">
                    </div>
                    <div class="hidden" id="listaPreciosAddPrecioGroup">
                        <label for="listaPreciosAddPrecioInput">Precio:</label>
                        <input type="number" id="listaPreciosAddPrecioInput">
                    </div>
                    <div class="hidden" id="listaPreciosAddPadreGroup">
                        <label for="listaPreciosAddPadreSelect">Padre (Concepto/Título):</label>
                        <select id="listaPreciosAddPadreSelect">
                            <option value="">Seleccione un padre</option>
                        </select>
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="listaPreciosAddModalConfirmBtn" class="confirm-btn">Guardar</button>
                    <button id="listaPreciosAddModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="listaPreciosEditModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="listaPreciosEditModalTitle">Editar Elemento</h3>
                 <div class="space-y-4 text-left">
                    <div>
                        <label for="listaPreciosEditDescripcionInput">Descripción:</label>
                        <input type="text" id="listaPreciosEditDescripcionInput">
                    </div>
                    <div class="hidden" id="listaPreciosEditCodigoGroup">
                        <label for="listaPreciosEditCodigoInput">Código:</label>
                        <input type="text" id="listaPreciosEditCodigoInput">
                    </div>
                    <div class="hidden" id="listaPreciosEditPrecioGroup">
                        <label for="listaPreciosEditPrecioInput">Precio:</label>
                        <input type="number" id="listaPreciosEditPrecioInput">
                    </div>
                    <div class="hidden" id="listaPreciosEditPadreGroup">
                        <label for="listaPreciosEditPadreSelect">Padre:</label>
                        <select id="listaPreciosEditPadreSelect"></select>
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="listaPreciosEditModalConfirmBtn" class="confirm-btn">Guardar</button>
                    <button id="listaPreciosEditModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>
        <div id="stockAddModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="stockAddModalTitle">Agregar Elemento al Stock</h3>
                <div class="space-y-4 text-left">
                    <div>
                        <label for="stockAddTipoSelect">Tipo de Elemento:</label>
                        <select id="stockAddTipoSelect">
                            <option value="titulo">Título (Ej: Carnes, Bebidas)</option>
                            <option value="producto">Producto (Ej: Pan de Papa)</option>
                        </select>
                    </div>
                    <div>
                        <label for="stockAddDescripcionInput">Descripción:</label>
                        <input type="text" id="stockAddDescripcionInput">
                    </div>
                    <div class="hidden" id="stockAddCodigoGroup">
                        <label for="stockAddCodigoInput">Código:</label>
                        <input type="text" id="stockAddCodigoInput">
                    </div>
                    <div class="hidden" id="stockAddCantidadGroup">
                        <label for="stockAddCantidadInput">Cantidad:</label>
                        <input type="number" id="stockAddCantidadInput">
                    </div>
                    <div class="hidden" id="stockAddPadreGroup">
                        <label for="stockAddPadreSelect">Padre (Título):</label>
                        <select id="stockAddPadreSelect">
                            <option value="">Seleccione un título padre</option>
                        </select>
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="stockAddModalConfirmBtn" class="confirm-btn">Guardar</button>
                    <button id="stockAddModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="stockEditModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="stockEditModalTitle">Editar Elemento del Stock</h3>
                 <div class="space-y-4 text-left">
                    <div>
                        <label for="stockEditDescripcionInput">Descripción:</label>
                        <input type="text" id="stockEditDescripcionInput">
                    </div>
                    <div class="hidden" id="stockEditCodigoGroup">
                        <label for="stockEditCodigoInput">Código:</label>
                        <input type="text" id="stockEditCodigoInput">
                    </div>
                    <div class="hidden" id="stockEditCantidadGroup">
                        <label for="stockEditCantidadInput">Cantidad:</label>
                        <input type="number" id="stockEditCantidadInput">
                    </div>
                    <div class="hidden" id="stockEditPadreGroup">
                        <label for="stockEditPadreSelect">Padre (Título):</label>
                        <select id="stockEditPadreSelect"></select>
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="stockEditModalConfirmBtn" class="confirm-btn">Guardar</button>
                    <button id="stockEditModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>


        <div id="vencimientosAddModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="vencimientosAddModalTitle">Agregar Elemento</h3>
                <div class="space-y-4 text-left">
                    <div>
                        <label for="vencimientosAddTipoSelect">Tipo de Elemento:</label>
                        <select id="vencimientosAddTipoSelect">
                            <option value="titulo">Título (Ej: Heladera, Freezer)</option>
                            <option value="producto">Producto</option>
                        </select>
                    </div>
                    <div id="vencimientosAddTituloGroup">
                        <label for="vencimientosAddDescripcionInput">Descripción del Título:</label>
                        <input type="text" id="vencimientosAddDescripcionInput">
                    </div>
                    <div class="hidden" id="vencimientosAddProductoGroup">
                        <div>
                            <label for="vencimientosAddPadreSelect">Padre (Título):</label>
                            <select id="vencimientosAddPadreSelect"></select>
                        </div>
                        <div>
                            <label for="vencimientosAddStockSelect">Producto del Stock:</label>
                            <select id="vencimientosAddStockSelect"></select>
                        </div>
                        <div>
                            <label for="vencimientosAddFechaInput">Fecha de Vencimiento:</label>
                            <input type="date" id="vencimientosAddFechaInput">
                        </div>
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="vencimientosAddModalConfirmBtn" class="confirm-btn">Guardar</button>
                    <button id="vencimientosAddModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="vencimientosEditModal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3 id="vencimientosEditModalTitle">Editar Elemento</h3>
                 <div class="space-y-4 text-left">
                    <div id="vencimientosEditTituloGroup">
                        <label for="vencimientosEditDescripcionInput">Descripción:</label>
                        <input type="text" id="vencimientosEditDescripcionInput">
                    </div>
                    <div class="hidden" id="vencimientosEditProductoGroup">
                         <div>
                            <label for="vencimientosEditPadreSelect">Padre (Título):</label>
                            <select id="vencimientosEditPadreSelect"></select>
                        </div>
                        <div>
                            <label>Producto:</label>
                            <input type="text" id="vencimientosEditProductoInfo" disabled class="bg-gray-700">
                        </div>
                        <div>
                            <label for="vencimientosEditFechaInput">Fecha de Vencimiento:</label>
                            <input type="date" id="vencimientosEditFechaInput">
                        </div>
                    </div>
                </div>
                <div class="custom-modal-buttons mt-6">
                    <button id="vencimientosEditModalConfirmBtn" class="confirm-btn">Guardar</button>
                    <button id="vencimientosEditModalCancelBtn" class="cancel-btn">Cancelar</button>
                </div>
            </div>
        </div>
        

        <!-- FRAME: Panel de Usuarios -->
        <div id="panelUsuariosFrame" class="app-frame">
             <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-white">Panel de Usuarios</h1>
                <img src="logo_empresa.png" alt="Logo de la Empresa" class="h-40" onerror="this.onerror=null;this.src='https://placehold.co/100x40/111827/ffffff?text=Logo';">
            </div>
            <div class="max-w-sm mx-auto bg-gray-800 p-8 rounded-2xl border border-gray-700">
                <div class="flex flex-col items-center gap-6">
                    <button id="createUserBtn" class="w-full btn btn-primary">Crear Usuario</button>
                    <button id="changePassBtn" class="w-full btn btn-secondary">Modificar Contraseña</button>
                    <button id="deleteUserBtn" class="w-full btn btn-danger">Eliminar Cuenta</button>
                </div>
            </div>
        </div>

    </div>

    <script>
    // --- Custom Modal (Replacement for alert/confirm) ---
    const modalOverlay = document.getElementById('customModalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalInputContainer = document.getElementById('modalInputContainer');
    const modalInput = document.getElementById('modalInput');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    let modalResolve;

    function showCustomAlert(title, message) {
        modalTitle.textContent = title;
        modalMessage.innerHTML = message.replace(/\n/g, '<br>');
        modalInputContainer.classList.add('hidden');
        modalConfirmBtn.textContent = 'Aceptar';
        modalCancelBtn.classList.add('hidden');
        modalOverlay.classList.add('show');

        return new Promise(resolve => {
            modalResolve = resolve;
            modalConfirmBtn.onclick = () => {
                modalOverlay.classList.remove('show');
                modalResolve(true);
            };
        });
    }

    function showCustomConfirm(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalInputContainer.classList.add('hidden');
        modalConfirmBtn.textContent = 'Sí';
        modalCancelBtn.textContent = 'No';
        modalCancelBtn.classList.remove('hidden');
        modalOverlay.classList.add('show');

        return new Promise(resolve => {
            modalResolve = resolve;
            modalConfirmBtn.onclick = () => {
                modalOverlay.classList.remove('show');
                modalResolve(true);
            };
            modalCancelBtn.onclick = () => {
                modalOverlay.classList.remove('show');
                modalResolve(false);
            };
        });
    }

    function showCustomPrompt(title, message, defaultValue = '') {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalInputContainer.classList.remove('hidden');
        modalInput.value = defaultValue;
        modalConfirmBtn.textContent = 'Aceptar';
        modalCancelBtn.textContent = 'Cancelar';
        modalCancelBtn.classList.remove('hidden');
        modalOverlay.classList.add('show');
        
        setTimeout(() => modalInput.focus(), 100);

        return new Promise(resolve => {
            const confirmHandler = () => {
                modalOverlay.classList.remove('show');
                cleanup();
                resolve(modalInput.value);
            };

            const cancelHandler = () => {
                modalOverlay.classList.remove('show');
                cleanup();
                resolve(null);
            };
            
            const keypressHandler = (e) => {
                if (e.key === 'Enter') {
                    confirmHandler();
                }
            };

            const cleanup = () => {
                modalConfirmBtn.removeEventListener('click', confirmHandler);
                modalCancelBtn.removeEventListener('click', cancelHandler);
                modalInput.removeEventListener('keypress', keypressHandler);
            };

            modalConfirmBtn.addEventListener('click', confirmHandler);
            modalCancelBtn.addEventListener('click', cancelHandler);
            modalInput.addEventListener('keypress', keypressHandler);
        });
    }


    // --- Global Application State and Data ---
    const API_BASE_URL = 'http://127.0.0.1:5000/api';
    
    const APP = {
        loggedInUser: null,
        loggedInRole: null,
        welcomePhrase: '', 
        billingChart: null,
        expensesChart: null,
        data: {
            users: [],
            ingresos: [],
            gastos: {},
            precios: [],
            costos: { ingredientes: [], hamburguesas: [] },
            stock: [], // NUEVO
            pedidos: [],
            clientes: [],
            proveedores: []
        },
        selectedIngresoData: null,
        selectedIngresoRow: null,
        selectedPriceData: null,
        selectedPriceRow: null,
        selectedStockData: null, // NUEVO
        selectedStockRow: null, // NUEVO
    };

    // --- Constants ---
    const MESES_ESPANOL = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const ANIOS = Array.from({ length: 20 }, (_, i) => String(2022 + i)); 

    // --- Utility Functions ---
// Helper function para crear un objeto Date de forma segura desde varios formatos
function safeParseDate(dateString) {
    if (!dateString) return null; // Maneja nulos, indefinidos o strings vacíos

    // Intenta parsear como ISO 8601 o YYYY-MM-DD (el constructor de Date los maneja bien)
    let d = new Date(dateString);
    if (!isNaN(d.getTime())) return d; // Si es válido, lo devuelve

    // Intenta parsear como DD/MM/YYYY (formato local común)
    const parts = String(dateString).split('/'); // Asegura que dateString sea un string
    if (parts.length === 3) {
        d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        if (!isNaN(d.getTime())) return d;
    }

    // Intenta parsear como DD-MM-YYYY
    const partsDash = String(dateString).split('-'); // Asegura que dateString sea un string
    // Comprobación básica para DD-MM-YYYY (ej. 01-08-2025)
    if (partsDash.length === 3 && partsDash[0].length === 2 && partsDash[1].length === 2 && partsDash[2].length === 4) {
         d = new Date(parseInt(partsDash[2]), parseInt(partsDash[1]) - 1, parseInt(partsDash[0]));
         if (!isNaN(d.getTime())) return d;
    }

    console.warn('safeParseDate: No se pudo parsear el string de fecha:', dateString); // Registra fechas problemáticas
    return null; // Retorna nulo si no se pudo parsear
}

    function formatDate(date) {
    if (!date) return '';

    // La modificación clave: usa safeParseDate para obtener un objeto Date válido
    const d = safeParseDate(date); 

    if (!d || isNaN(d.getTime())) {
        // Si safeParseDate no pudo, significa que la entrada es realmente inválida
        console.warn("formatDate recibió una entrada de fecha inválida después de intentar parsear:", date);
        return 'Fecha Inválida'; // O puedes retornar '' si prefieres que no se muestre nada
    }

    // El resto de la lógica para la corrección de zona horaria y formato permanece igual
    const userTimezoneOffset = d.getTimezoneOffset() * 60000;
    const correctedDate = new Date(d.getTime() + userTimezoneOffset);

    const day = String(correctedDate.getDate()).padStart(2, '0');
    const month = String(correctedDate.getMonth() + 1).padStart(2, '0');
    const year = correctedDate.getFullYear();
    return `${day}/${month}/${year}`;
}
    
    function formatDateForInput(date) {
        if (!date) return '';
        const d = new Date(date);
        const userTimezoneOffset = d.getTimezoneOffset() * 60000;
        const correctedDate = new Date(d.getTime() + userTimezoneOffset);

        const day = String(correctedDate.getDate()).padStart(2, '0');
        const month = String(correctedDate.getMonth() + 1).padStart(2, '0');
        const year = correctedDate.getFullYear();
        return `${year}-${month}-${day}`;
    }

    function parseDate(dateString) {
        if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) throw new Error("Invalid date format");
        const [day, month, year] = dateString.split('/').map(Number);
        return new Date(year, month - 1, day);
    }
    
    function formatCurrency(value) {
        try {
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            return `$${num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        } catch (e) {
            return value;
        }
    }
    
    function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }


    
    // --- Configuración global de Chart.js para el tema oscuro ---
    function setupChartDefaults() {
        Chart.defaults.color = '#d1d5db'; // text-gray-300
        Chart.defaults.borderColor = '#4b5563'; // gray-600
        Chart.defaults.plugins.legend.labels.color = '#d1d5db';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(10, 10, 10, 0.8)'; // Usa tu color --color-surface
        Chart.defaults.plugins.tooltip.titleColor = '#f9fafb'; // text-gray-50
        Chart.defaults.plugins.tooltip.bodyColor = '#d1d5db'; // text-gray-300
        Chart.defaults.plugins.tooltip.borderColor = '#34d399'; // green-400
        Chart.defaults.plugins.tooltip.borderWidth = 1;
    }

    

    APP.getPriceForDate = function(item, targetDate) { // <<< PEGA AQUÍ Y AÑADE 'APP.'
        if (item.tipo !== 'item' || !item.price_history || item.price_history.length === 0) return undefined;
        const validPrices = item.price_history
            .map(p => ({ ...p, dateObj: new Date(p.date) }))
            .filter(p => p.dateObj <= targetDate)
            .sort((a, b) => b.dateObj - a.dateObj);
        return validPrices.length > 0 ? validPrices[0].price : undefined;
    };


    // --- Core App Functions ---
    APP.showFrame = function(frameId) {
        const sidebar = document.getElementById('sidebar');
        const appContainer = document.getElementById('appContainer');

        if (frameId === 'loginFrame') {
            sidebar.classList.remove('visible');
            appContainer.classList.remove('sidebar-active');
        } else {
            sidebar.classList.add('visible');
            appContainer.classList.add('sidebar-active');
        }

        document.querySelectorAll('.app-frame').forEach(frame => {
            frame.classList.remove('active');
        });
        const targetFrame = document.getElementById(frameId);
        if (targetFrame) {
            targetFrame.classList.add('active');
        } else {
            console.error(`Error: Frame con ID '${frameId}' no encontrado.`);
            return; 
        }

        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.toggle('active', link.dataset.frame === frameId);
        });

        // Cargar datos específicos del frame
        if (frameId === 'inicioFrame') APP.Inicio.updateDashboard();
        else if (frameId === 'inicioLimitadoFrame') APP.InicioLimitado.updateDashboard();
        else if (frameId === 'gastosFrame') APP.Gastos.displayGastos();
        else if (frameId === 'ingresosFrame') APP.Ingresos.displayIngresos();
        else if (frameId === 'listaPreciosFrame') APP.ListaPrecios.displayPriceList();
        else if (frameId === 'costosFrame') APP.Costos.displayCostos();
        else if (frameId === 'stockFrame') APP.Stock.displayStock(); // NUEVO
        else if (frameId === 'vencimientosFrame') APP.Vencimientos.displayVencimientos();
        else if (frameId === 'pedidosFrame') APP.Pedidos.displayPedidos();
        else if (frameId === 'clientesFrame') APP.Clientes.displayClientes();
        else if (frameId === 'proveedoresFrame') APP.Proveedores.displayProveedores();
    };

    APP.loadInitialData = async function() {
        try {
            const response = await fetch(`${API_BASE_URL}/data`);
            if (!response.ok) {
                throw new Error(`Error al cargar datos: ${response.statusText}`);
            }
            const allData = await response.json();
            
            APP.data = {
                users: [], ingresos: [], gastos: {}, precios: [],
                costos: { ingredientes: [], hamburguesas: [] },
                stock: [], // NUEVO
                ...allData
            };
            
            APP.data.precios.forEach(item => {
                if(item.tipo === 'item' && item.precio !== undefined && !item.price_history) {
                    item.price_history = [{ date: '2022-01-01', price: item.precio }];
                }
            });

            APP.Sidebar.build();
        } catch (error) {
            console.error("Error de red o del servidor:", error);
            await showCustomAlert("Error de Carga", "No se pudieron cargar los datos de la aplicación. Verifique que el servidor Python esté funcionando y recargue la página.");
        }
    };

    // --- APP Modules (Connected to Backend) ---
    
    APP.Sidebar = (function() {
        const sidebarContainer = document.getElementById('sidebar');
        
        const icons = {
            inicio: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>`,
            gastos: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
            ingresos: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
            listaPrecios: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 0v11a2 2 0 002 2h5a2 2 0 002-2V5a2 2 0 00-2-2H7z"></path></svg>`,
            costos: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-2a2 2 0 100 4 2 2 0 000-4zm0 7.01V12m0 6v-1m0-2a2 2 0 100 4 2 2 0 000-4zm0 0h.01M12 21v-1m0-2a2 2 0 100 4 2 2 0 000-4z"></path></svg>`, 
            stock: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7s0 0 0 0m16 0s0 0 0 0M12 15v6m-4-3h8"></path></svg>`, // NUEVO ICONO
            vencimientos: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,
            pedidos: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`,
            panelUsuarios: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
            proveedores: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7s0 0 0 0m16 0s0 0 0 0M12 15v6m-4-3h8"></path></svg>`,
            logout: `<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>`
            
        };

        const buttonsConfig = {
            admin: [
                { text: "Inicio", frame: "inicioFrame", icon: icons.inicio },
                { text: "Ventas", frame: "pedidosFrame", icon: icons.pedidos },
                { text: "Stock", frame: "stockFrame", icon: icons.stock }, // NUEVO
                { text: "Vencimientos", frame: "vencimientosFrame", icon: icons.vencimientos },
                { text: "Costos", frame: "costosFrame", icon: icons.costos },
                { text: "Gestión de Gastos", frame: "gastosFrame", icon: icons.gastos },
                { text: "Ingresos", frame: "ingresosFrame", icon: icons.ingresos },
                { text: "Lista de Precios", frame: "listaPreciosFrame", icon: icons.listaPrecios },
                { text: "Proveedores", frame: "proveedoresFrame", icon: icons.proveedores },
                { text: "Panel de Usuarios", frame: "panelUsuariosFrame", icon: icons.panelUsuarios },
            ],
            limitado: [
                { text: "Inicio", frame: "inicioLimitadoFrame", icon: icons.inicio },
                { text: "Ventas", frame: "pedidosFrame", icon: icons.pedidos },
                { text: "Stock", frame: "stockFrame", icon: icons.stock },
                { text: "Vencimientos", frame: "vencimientosFrame", icon: icons.vencimientos },
                { text: "Lista de Precios", frame: "listaPreciosFrame", icon: icons.listaPrecios },
                { text: "Proveedores", frame: "proveedoresFrame", icon: icons.proveedores },
            ]
        };

        function build() {
            sidebarContainer.innerHTML = '';
            const role = APP.loggedInRole;
            if (!role) return;

            const header = document.createElement('div');
            header.className = 'sidebar-header';
            header.innerHTML = `<img src="logo_empresa.png" alt="Logo de la Empresa" class="sidebar-logo" onerror="this.onerror=null;this.src='https://placehold.co/120x80/111827/ffffff?text=Logo';">`;
            sidebarContainer.appendChild(header);

            const nav = document.createElement('nav');
            nav.className = 'sidebar-nav';
            sidebarContainer.appendChild(nav);

            buttonsConfig[role].forEach(btn => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'sidebar-link';
                link.innerHTML = `${btn.icon}<span>${btn.text}</span>`;
                link.dataset.frame = btn.frame;
                link.onclick = (e) => {
                    e.preventDefault();
                    APP.showFrame(btn.frame);
                };
                nav.appendChild(link);
            });

            const logoutLink = document.createElement('a');
            logoutLink.href = '#';
            logoutLink.className = 'sidebar-link sidebar-logout';
            logoutLink.innerHTML = `${icons.logout}<span>Cerrar Sesión</span>`;
            logoutLink.onclick = (e) => {
                e.preventDefault();
                APP.Menu.handleLogout();
            };
            sidebarContainer.appendChild(logoutLink);
        }
        return { build };
    })();

    APP.Login = (function() {
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                await showCustomAlert('Datos incompletos', 'Por favor, ingrese usuario y contraseña.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/data/users/authenticate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const authData = await response.json();
                    APP.loggedInUser = authData.user.usuario;
                    APP.loggedInRole = authData.user.rol;
                    APP.welcomePhrase = authData.user.frase_bienvenida;

                    await APP.loadInitialData(); 
                    APP.showFrame('inicioFrame');
                } else {
                    const errorData = await response.json();
                    await showCustomAlert('Error de inicio de sesión', errorData.error || 'Usuario o contraseña incorrectos.');
                }
            } catch (error) {
                console.error("Error de red en login:", error);
                await showCustomAlert("Error de Conexión", "No se pudo conectar con el servidor. Por favor, verifique que el backend esté en ejecución.");
            }
        }
        return {
            init: function() {
                document.getElementById('loginBtn').addEventListener('click', handleLogin);
                document.getElementById('loginUsername').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
                document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            }
        };
    })();

    APP.Menu = (function() {
        function handleLogout() {
            APP.loggedInUser = null;
            APP.loggedInRole = null;
            APP.welcomePhrase = '';
            APP.data = { users: [], ingresos: [], gastos: {}, precios: [], costos: { ingredientes: [], hamburguesas: [] }, stock: [] }; // Updated APP.data

            document.getElementById('sidebar').classList.remove('visible');
            document.getElementById('appContainer').classList.remove('sidebar-active');

            APP.showFrame('loginFrame');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        return { 
            init: function() { },
            handleLogout: handleLogout
        };
    })();

    
   APP.Inicio = (function() {
        // Selectores de Mes/Año
        const monthSelector = document.getElementById('dashboardMonthSelector');
        const yearSelector = document.getElementById('dashboardYearSelector');

        // Referencias Panel Resumen
        const resumenTitleEl = document.getElementById('resumenTitleEl');
        const monthlyIncomeEl = document.getElementById('monthlyIncome');
        const monthlyCostEl = document.getElementById('monthlyCost'); // NUEVO
        const monthlyExpensesEl = document.getElementById('monthlyExpenses');
        const monthlyBalanceEl = document.getElementById('monthlyBalance');

        // Referencias Panel Ventas por Producto
        const gananciaTitleEl = document.getElementById('gananciaTitleEl');
        const rubrosContainer = document.getElementById('dashboardRubros');

        // Referencias Alertas Vencimientos
        const alertaVencimientoBox = document.getElementById('inicioAlertaVencimientoBox');
        const alertaVencimientoLista = document.getElementById('inicioAlertaVencimientoLista');
        const alertaVencidosBox = document.getElementById('inicioAlertaVencidosBox');
        const alertaVencidosLista = document.getElementById('inicioAlertaVencidosLista');

        // Referencias Alerta Stock
        const alertaStockBox = document.getElementById('inicioAlertaStockBox'); // NUEVO
        const alertaStockLista = document.getElementById('inicioAlertaStockLista'); // NUEVO

        // --- Función principal que se llama para actualizar todo el dashboard ---
        function updateDashboard() {
            initializeSelectors();
            const welcomeElement = document.getElementById('welcomePhraseText');
            if (welcomeElement) {
                welcomeElement.textContent = APP.welcomePhrase || '¡Bienvenido/a!';
            }
            updateMonthlyPanels(); // Actualiza Resumen y Ventas x Producto
            updateAlertas(); // Actualiza todas las alertas
        }

        // --- Inicializar Selectores ---
        function initializeSelectors() {
            if (monthSelector.options.length === 0) {
                const currentMonth = new Date().getMonth();
                MESES_ESPANOL.forEach((month, index) => {
                    const option = new Option(month, index);
                    if (index === currentMonth) option.selected = true;
                    monthSelector.appendChild(option);
                });
                monthSelector.addEventListener('change', updateMonthlyPanels);
            }
            if (yearSelector.options.length === 0) {
                const currentYear = new Date().getFullYear();
                ANIOS.forEach(year => {
                    const option = new Option(year, year);
                    if (parseInt(year) === currentYear) option.selected = true;
                    yearSelector.appendChild(option);
                });
                yearSelector.addEventListener('change', updateMonthlyPanels);
            }
        }

        // --- Actualizar Paneles Mensuales ---
        function updateMonthlyPanels() {
            const selectedMonth = parseInt(monthSelector.value);
            const selectedYear = parseInt(yearSelector.value);
            const selectedMonthName = MESES_ESPANOL[selectedMonth];

            // Actualizar títulos
            if (resumenTitleEl) resumenTitleEl.textContent = `Resumen del Mes (${selectedMonthName} ${selectedYear})`;
            if (gananciaTitleEl) gananciaTitleEl.textContent = `Total Vendido por Producto (${selectedMonthName} ${selectedYear})`;

            // Filtrar pedidos entregados del mes
            const pedidosDelMes = APP.data.pedidos.filter(p => {
                // Usamos fecha_entrega si existe, si no, fecha_creacion como fallback
                const fechaReferencia = p.fecha_entrega || p.fecha_creacion;
                if (!fechaReferencia) return false; // Si no hay fecha, no se puede incluir
                const fechaPedido = safeParseDate(fechaReferencia);
                return p.estado === 'entregado' && fechaPedido && fechaPedido.getMonth() === selectedMonth && fechaPedido.getFullYear() === selectedYear;
            });

            calculateMonthlySummary(pedidosDelMes, selectedMonth, selectedYear);
            calculateSalesByProduct(pedidosDelMes);
        }

        // --- Calcular Resumen del Mes ---
        function calculateMonthlySummary(pedidosDelMes, month, year) {
            let totalIngresos = 0;
            let totalCosto = 0; // NUEVO
            let totalGastos = 0;

            // 1. Calcular Ingresos y Costos desde los pedidos
            pedidosDelMes.forEach(pedido => {
                totalIngresos += parseFloat(pedido.montoTotal || 0);
                pedido.items.forEach(itemVendido => {
                    // Buscar el item correspondiente en precios para obtener el costo
                    const itemPrecio = APP.data.precios.find(p => p.id === itemVendido.id);
                    if (itemPrecio && itemPrecio.costo !== null && itemPrecio.costo !== undefined) {
                        const costoUnitario = parseFloat(itemPrecio.costo);
                        if (!isNaN(costoUnitario)) {
                            totalCosto += costoUnitario * (itemVendido.cantidad || 1);
                        }
                    }
                });
            });

            // 2. Calcular Gastos pagados del mes
            const monthName = MESES_ESPANOL[month];
            if (APP.loggedInRole === 'admin' && APP.data.gastos[year] && APP.data.gastos[year][monthName]) {
                totalGastos = APP.data.gastos[year][monthName].reduce((sum, gasto) => {
                    return sum + (gasto.pagado === 'si' ? parseFloat(gasto.monto || 0) : 0);
                }, 0);
            }

            const balanceMes = totalIngresos - totalCosto - totalGastos; // NUEVO CÁLCULO

            // 3. Mostrar resultados
            monthlyIncomeEl.textContent = formatCurrency(totalIngresos);
            monthlyCostEl.textContent = formatCurrency(totalCosto); // NUEVO
            monthlyExpensesEl.textContent = formatCurrency(totalGastos);
            monthlyBalanceEl.textContent = formatCurrency(balanceMes);
            monthlyBalanceEl.style.color = balanceMes >= 0 ? 'var(--color-accent)' : 'var(--color-danger)';
        }

        // --- Calcular Ventas por Producto ---
        function calculateSalesByProduct(pedidosDelMes) {
            rubrosContainer.innerHTML = '';
            const ventasPorProducto = {}; // Objeto para acumular ventas { descripcion: totalVendido }
            let ventaTotalMes = 0;

            // Acumular ventas por cada producto vendido
            pedidosDelMes.forEach(pedido => {
                pedido.items.forEach(item => {
                    const ventaItem = (item.precio || 0) * (item.cantidad || 1);
                    if (!ventasPorProducto[item.descripcion]) {
                        ventasPorProducto[item.descripcion] = 0;
                    }
                    ventasPorProducto[item.descripcion] += ventaItem;
                    ventaTotalMes += ventaItem;
                });
            });

            // Convertir a array, ordenar y mostrar (solo los vendidos)
            const sortedVentas = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a);

            if (sortedVentas.length > 0) {
                sortedVentas.forEach(([nombre, totalVendido]) => {
                    const porcentaje = ventaTotalMes > 0 ? (totalVendido / ventaTotalMes) * 100 : 0;
                    const rubroEl = document.createElement('div');
                    rubroEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-300">${nombre} (${formatCurrency(totalVendido)})</span>
                            ${ventaTotalMes > 0 ? `<span class="text-sm font-semibold text-white">${porcentaje.toFixed(1)}%</span>` : ''}
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${porcentaje}%"></div>
                        </div>
                    `;
                    rubrosContainer.appendChild(rubroEl);
                });
            } else {
                rubrosContainer.innerHTML = '<p class="text-gray-400 italic text-center">No hubo ventas este mes.</p>';
            }
        }

        // --- Actualizar Todas las Alertas ---
        function updateAlertas() {
            updateAlertaVencimientos();
            updateAlertaStock();
        }

        // --- Lógica Alertas Vencimientos (Adaptada de APP.Vencimientos) ---
        function updateAlertaVencimientos() {
            alertaVencimientoLista.innerHTML = '';
            alertaVencidosLista.innerHTML = ''; // Limpiar también la lista de vencidos

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const limiteFecha = new Date(hoy);
            limiteFecha.setMonth(limiteFecha.getMonth() + 2);

            const productosPorVencer = [];
            const productosVencidos = [];

            APP.data.vencimientos.forEach(item => {
                if (item.tipo !== 'producto') return;
                const fechaVencimiento = safeParseDate(item.vencimiento);
                if (!fechaVencimiento) return;

                if (fechaVencimiento < hoy) {
                    productosVencidos.push(item);
                } else if (fechaVencimiento <= limiteFecha) {
                    productosPorVencer.push(item);
                }
            });

            // Mostrar alerta "Por Vencer"
            if (productosPorVencer.length > 0) {
                productosPorVencer.sort((a, b) => safeParseDate(a.vencimiento) - safeParseDate(b.vencimiento));
                productosPorVencer.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `[${item.codigo}] ${item.descripcion} - Vence: ${formatDate(item.vencimiento)}`;
                    alertaVencimientoLista.appendChild(li);
                });
                alertaVencimientoBox.classList.remove('hidden');
            } else {
                alertaVencimientoBox.classList.add('hidden');
            }

            // Mostrar alerta "Vencidos"
            if (productosVencidos.length > 0) {
                productosVencidos.sort((a, b) => safeParseDate(a.vencimiento) - safeParseDate(b.vencimiento));
                productosVencidos.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `[${item.codigo}] ${item.descripcion} - Venció: ${formatDate(item.vencimiento)}`;
                    alertaVencidosLista.appendChild(li);
                });
                alertaVencidosBox.classList.remove('hidden');
            } else {
                alertaVencidosBox.classList.add('hidden');
            }
        }

        // --- Lógica Alerta Stock Bajo ---
        function updateAlertaStock() {
            alertaStockLista.innerHTML = '';
            const stockBajo = APP.data.stock.filter(item =>
                item.tipo === 'producto' && (!item.cantidad || parseFloat(item.cantidad) <= 0)
            );

            if (stockBajo.length > 0) {
                stockBajo.sort((a, b) => a.descripcion.localeCompare(b.descripcion)); // Ordenar alfabéticamente
                stockBajo.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `[${item.codigo}] ${item.descripcion}`;
                    alertaStockLista.appendChild(li);
                });
                alertaStockBox.classList.remove('hidden');
            } else {
                alertaStockBox.classList.add('hidden');
            }
        }

        return {
            init: function() {
                // Ya no hay botón de Rappi/Banco para inicializar
            },
            updateDashboard: updateDashboard
        };
    })();     

    APP.InicioLimitado = (function() {
        // Selectores de Mes/Año (con sufijo Limitado)
        const monthSelector = document.getElementById('dashboardMonthSelectorLimitado');
        const yearSelector = document.getElementById('dashboardYearSelectorLimitado');

        // Referencias Panel Ventas por Producto (con sufijo Limitado)
        const gananciaTitleEl = document.getElementById('gananciaTitleElLimitado');
        const rubrosContainer = document.getElementById('dashboardRubrosLimitado');

        // Referencias Alertas (con sufijo Limitado)
        const alertaStockBox = document.getElementById('inicioAlertaStockBoxLimitado');
        const alertaStockLista = document.getElementById('inicioAlertaStockListaLimitado');
        const alertaVencimientoBox = document.getElementById('inicioAlertaVencimientoBoxLimitado');
        const alertaVencimientoLista = document.getElementById('inicioAlertaVencimientoListaLimitado');
        const alertaVencidosBox = document.getElementById('inicioAlertaVencidosBoxLimitado');
        const alertaVencidosLista = document.getElementById('inicioAlertaVencidosListaLimitado');

        // Referencia Saludo (con sufijo Limitado)
        const welcomeElement = document.getElementById('welcomePhraseTextLimitado'); // Asegúrate de que este ID coincida con el HTML

        function updateDashboard() {
            initializeSelectors();
            if (welcomeElement) { // Usar la referencia correcta
                welcomeElement.textContent = APP.welcomePhrase || '¡Bienvenido/a!';
            }
            updateMonthlyPanels();
            updateAlertas();
        }

        function initializeSelectors() {
            // ... (Lógica igual, pero usa monthSelector y yearSelector con sufijo) ...
             if (monthSelector.options.length === 0) { // Usa la variable local correcta
                const currentMonth = new Date().getMonth();
                MESES_ESPANOL.forEach((month, index) => {
                    const option = new Option(month, index);
                    if (index === currentMonth) option.selected = true;
                    monthSelector.appendChild(option);
                });
                monthSelector.addEventListener('change', updateMonthlyPanels);
            }
            if (yearSelector.options.length === 0) { // Usa la variable local correcta
                const currentYear = new Date().getFullYear();
                ANIOS.forEach(year => {
                    const option = new Option(year, year);
                    if (parseInt(year) === currentYear) option.selected = true;
                    yearSelector.appendChild(option);
                });
                yearSelector.addEventListener('change', updateMonthlyPanels);
            }
        }

        function updateMonthlyPanels() {
            const selectedMonth = parseInt(monthSelector.value); // Usa la variable local correcta
            const selectedYear = parseInt(yearSelector.value); // Usa la variable local correcta
            const selectedMonthName = MESES_ESPANOL[selectedMonth];

            if (gananciaTitleEl) gananciaTitleEl.textContent = `Total Vendido por Producto (${selectedMonthName} ${selectedYear})`;

            const pedidosDelMes = APP.data.pedidos.filter(p => {
                const fechaReferencia = p.fecha_entrega || p.fecha_creacion;
                if (!fechaReferencia) return false;
                const fechaPedido = safeParseDate(fechaReferencia);
                return p.estado === 'entregado' && fechaPedido && fechaPedido.getMonth() === selectedMonth && fechaPedido.getFullYear() === selectedYear;
            });

            // calculateMonthlySummary(pedidosDelMes, selectedMonth, selectedYear); // <-- LÍNEA BORRADA
            calculateSalesByProduct(pedidosDelMes);
        }

        // calculateMonthlySummary() <-- FUNCIÓN BORRADA

        function calculateSalesByProduct(pedidosDelMes) {
            // ... (Lógica igual, pero usa rubrosContainer con sufijo) ...
            rubrosContainer.innerHTML = ''; // Usa la variable local correcta
            const ventasPorProducto = {};
            let ventaTotalMes = 0;

            pedidosDelMes.forEach(pedido => {
                pedido.items.forEach(item => {
                    const ventaItem = (item.precio || 0) * (item.cantidad || 1);
                    if (!ventasPorProducto[item.descripcion]) {
                        ventasPorProducto[item.descripcion] = 0;
                    }
                    ventasPorProducto[item.descripcion] += ventaItem;
                    ventaTotalMes += ventaItem;
                });
            });

            const sortedVentas = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a);

            if (sortedVentas.length > 0) {
                sortedVentas.forEach(([nombre, totalVendido]) => {
                    const porcentaje = ventaTotalMes > 0 ? (totalVendido / ventaTotalMes) * 100 : 0;
                    const rubroEl = document.createElement('div');
                    rubroEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-300">${nombre} (${formatCurrency(totalVendido)})</span>
                            ${ventaTotalMes > 0 ? `<span class="text-sm font-semibold text-white">${porcentaje.toFixed(1)}%</span>` : ''}
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${porcentaje}%"></div>
                        </div>
                    `;
                    rubrosContainer.appendChild(rubroEl); // Usa la variable local correcta
                });
            } else {
                rubrosContainer.innerHTML = '<p class="text-gray-400 italic text-center">No hubo ventas este mes.</p>'; // Usa la variable local correcta
            }
        }

        function updateAlertas() {
             updateAlertaVencimientos();
             updateAlertaStock();
        }

        function updateAlertaVencimientos() {
            // ... (Lógica igual, pero usa alerta...Lista/Box con sufijo Limitado) ...
            alertaVencimientoLista.innerHTML = ''; // Usa la variable local correcta
            alertaVencidosLista.innerHTML = ''; // Usa la variable local correcta

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const limiteFecha = new Date(hoy);
            limiteFecha.setMonth(limiteFecha.getMonth() + 2);

            const productosPorVencer = [];
            const productosVencidos = [];

            APP.data.vencimientos.forEach(item => {
                if (item.tipo !== 'producto') return;
                const fechaVencimiento = safeParseDate(item.vencimiento);
                if (!fechaVencimiento) return;

                if (fechaVencimiento < hoy) {
                    productosVencidos.push(item);
                } else if (fechaVencimiento <= limiteFecha) {
                    productosPorVencer.push(item);
                }
            });

            if (productosPorVencer.length > 0) {
                productosPorVencer.sort((a, b) => safeParseDate(a.vencimiento) - safeParseDate(b.vencimiento));
                productosPorVencer.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `[${item.codigo}] ${item.descripcion} - Vence: ${formatDate(item.vencimiento)}`;
                    alertaVencimientoLista.appendChild(li); // Usa la variable local correcta
                });
                alertaVencimientoBox.classList.remove('hidden'); // Usa la variable local correcta
            } else {
                alertaVencimientoBox.classList.add('hidden'); // Usa la variable local correcta
            }

            if (productosVencidos.length > 0) {
                productosVencidos.sort((a, b) => safeParseDate(a.vencimiento) - safeParseDate(b.vencimiento));
                productosVencidos.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `[${item.codigo}] ${item.descripcion} - Venció: ${formatDate(item.vencimiento)}`;
                    alertaVencidosLista.appendChild(li); // Usa la variable local correcta
                });
                alertaVencidosBox.classList.remove('hidden'); // Usa la variable local correcta
            } else {
                alertaVencidosBox.classList.add('hidden'); // Usa la variable local correcta
            }
        }

        function updateAlertaStock() {
            // ... (Lógica igual, pero usa alertaStockLista/Box con sufijo Limitado) ...
             alertaStockLista.innerHTML = ''; // Usa la variable local correcta
            const stockBajo = APP.data.stock.filter(item =>
                item.tipo === 'producto' && (!item.cantidad || parseFloat(item.cantidad) <= 0)
            );

            if (stockBajo.length > 0) {
                stockBajo.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                stockBajo.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `[${item.codigo}] ${item.descripcion}`;
                    alertaStockLista.appendChild(li); // Usa la variable local correcta
                });
                alertaStockBox.classList.remove('hidden'); // Usa la variable local correcta
            } else {
                alertaStockBox.classList.add('hidden'); // Usa la variable local correcta
            }
        }


        return {
            init: function() { },
            updateDashboard: updateDashboard
        };
    })();
    // --- FIN: MÓDULO APP.InicioLimitado ---



    APP.Gastos = (function() {
        const monthSelector = document.getElementById('gastosMonthSelector');
        const yearSelector = document.getElementById('gastosYearSelector');
        const totalesLabel = document.getElementById('gastosTotalesLabel');
        const tableBody = document.getElementById('gastosTableBody');
        const noConceptsMessage = document.getElementById('gastosNoConceptosMessage');
        const tableHead = document.querySelector('#gastosFrame thead');
        const exportBtn = document.getElementById('gastosExportarBtn');

        function initializeSelectors() {
            monthSelector.innerHTML = '';
            const currentMonth = new Date().getMonth();
            MESES_ESPANOL.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthSelector.appendChild(option);
            });
            monthSelector.addEventListener('change', displayGastos);

            yearSelector.innerHTML = '';
            const currentYear = new Date().getFullYear();
            ANIOS.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (parseInt(year) === currentYear) option.selected = true;
                yearSelector.appendChild(option);
            });
            yearSelector.addEventListener('change', displayGastos);
        }

        async function saveMonthData(month, year, data) {
            try {
                const response = await fetch(`${API_BASE_URL}/data/gastos/month/${month}/year/${year}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Error al guardar los gastos.');
                }
                return true;
            } catch (error) {
                console.error("Error guardando gastos:", error);
                await showCustomAlert("Error", `No se pudieron guardar los cambios en los gastos: ${error.message}`);
                displayGastos(); 
                return false;
            }
        }
        
        async function displayGastos() {
            tableBody.innerHTML = '';
            const selectedMonth = monthSelector.value;
            const selectedYear = yearSelector.value;

            try {
                const response = await fetch(`${API_BASE_URL}/data/gastos/month/${selectedMonth}/year/${selectedYear}`);
                if (!response.ok) {
                    throw new Error(`Error al cargar gastos: ${response.statusText}`);
                }
                const currentMonthData = await response.json();
                
                if (!APP.data.gastos[selectedYear]) {
                    APP.data.gastos[selectedYear] = {};
                }
                APP.data.gastos[selectedYear][selectedMonth] = currentMonthData;

                let total = 0, totalPagado = 0, totalPendiente = 0;

                tableHead.innerHTML = `
                    <tr>
                        <th class="table-header-cell rounded-tl-xl text-center w-12"><input type="checkbox" id="gastosSelectAllCheckbox" class="bg-gray-700 border-gray-600"></th>
                        <th class="table-header-cell text-center">Concepto</th>
                        <th class="table-header-cell text-center">Monto</th>
                        <th class="table-header-cell text-center">Estado</th>
                        <th class="table-header-cell text-center">Fecha Pago</th>
                        <th class="table-header-cell rounded-tr-xl text-center">Acciones</th>
                    </tr>
                `;

                if (!currentMonthData || currentMonthData.length === 0) {
                    noConceptsMessage.classList.remove('hidden');
                    totalesLabel.textContent = "Totales: $0.00 | Pagado: $0.00 | Pendiente: $0.00";
                    return;
                } 
                noConceptsMessage.classList.add('hidden');

                currentMonthData.forEach((item, idx) => {
                    const row = tableBody.insertRow();
                    row.className = 'table-row';

                    const selectCell = row.insertCell();
                    selectCell.className = 'text-center table-cell';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'gasto-checkbox form-checkbox h-5 w-5 text-green-500 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-offset-gray-800';
                    checkbox.dataset.concepto = item.concepto;
                    selectCell.appendChild(checkbox);

                    const monto = parseFloat(item.monto || 0);
                    const pagado = item.pagado === "si";

                    if (!isNaN(monto)) {
                        total += monto;
                        if (pagado) totalPagado += monto;
                        else totalPendiente += monto;
                    }

                    row.insertCell().textContent = item.concepto;
                    row.insertCell().textContent = formatCurrency(monto);
                    const estadoCell = row.insertCell();
                    estadoCell.textContent = pagado ? "PAGADO" : "PENDIENTE";
                    estadoCell.className = `${pagado ? "text-green-400" : "text-rose-400"} font-bold text-center`;
                    row.insertCell().textContent = item.fecha || "N/A";
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'flex justify-center gap-2 p-2';

                    const pagarBtn = document.createElement('button');
                    pagarBtn.textContent = 'Pagar';
                    pagarBtn.className = 'px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-md text-sm';
                    pagarBtn.onclick = () => updateGasto(idx, { pagado: "si", fecha: formatDate(new Date()) });
                    
                    const cancelarPagoBtn = document.createElement('button');
                    cancelarPagoBtn.textContent = 'Cancelar';
                    cancelarPagoBtn.className = 'px-3 py-1 bg-amber-500 hover:bg-amber-600 text-black rounded-md text-sm';
                    cancelarPagoBtn.onclick = () => updateGasto(idx, { pagado: "no", fecha: "" });

                    const montoBtn = document.createElement('button');
                    montoBtn.textContent = 'Monto';
                    montoBtn.className = 'px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm';
                    montoBtn.onclick = () => agregarMonto(idx);

                    actionsCell.appendChild(pagarBtn);
                    actionsCell.appendChild(cancelarPagoBtn);
                    actionsCell.appendChild(montoBtn);
                });
                totalesLabel.innerHTML = `Total: <span class="text-white">${formatCurrency(total)}</span> | Pagado: <span class="text-green-400">${formatCurrency(totalPagado)}</span> | Pendiente: <span class="text-rose-400">${formatCurrency(totalPendiente)}</span>`;
                
                document.getElementById('gastosSelectAllCheckbox').addEventListener('change', (e) => {
                    document.querySelectorAll('.gasto-checkbox').forEach(chk => {
                        chk.checked = e.target.checked;
                    });
                });

            } catch (error) {
                console.error("Error al cargar y mostrar gastos:", error);
                await showCustomAlert("Error de Carga", `No se pudieron cargar los gastos para este mes: ${error.message}.`);
                totalesLabel.textContent = "Totales: $0.00 | Pagado: $0.00 | Pendiente: $0.00";
                noConceptsMessage.classList.remove('hidden');
            }
        }

        async function updateGasto(idx, updates) {
            const selectedMonth = monthSelector.value;
            const selectedYear = yearSelector.value;
            if (!APP.data.gastos[selectedYear] || !APP.data.gastos[selectedYear][selectedMonth]) {
                await displayGastos();
            }
            Object.assign(APP.data.gastos[selectedYear][selectedMonth][idx], updates);
            if (await saveMonthData(selectedMonth, selectedYear, APP.data.gastos[selectedYear][selectedMonth])) {
                displayGastos();
            }
        }
        
        async function agregarMonto(idx) {
            const selectedMonth = monthSelector.value;
            const selectedYear = yearSelector.value;
            const currentConcepto = APP.data.gastos[selectedYear][selectedMonth][idx].concepto;
            const valor = await showCustomPrompt('Agregar Monto', `Ingrese el monto para ${currentConcepto}:`, APP.data.gastos[selectedYear][selectedMonth][idx].monto || '');
            if (valor !== null) {
                try {
                    const valFloat = parseFloat(valor.replace(",", "."));
                    if (isNaN(valFloat) || valFloat < 0) throw new Error("Monto inválido.");
                    await updateGasto(idx, { monto: valFloat.toFixed(2), pagado: "no", fecha: "" });
                } catch (e) {
                    await showCustomAlert('Error', 'Monto inválido. Ingrese un número positivo válido.');
                }
            }
        }
        
        async function agregarConcepto() {
            const concepto = await showCustomPrompt('Agregar Concepto', 'Nombre del nuevo concepto:');
            if (concepto && concepto.trim()) {
                const selectedMonth = monthSelector.value;
                const selectedYear = yearSelector.value;

                await displayGastos();

                if (!APP.data.gastos[selectedYear]) {
                    APP.data.gastos[selectedYear] = {};
                }
                if (!APP.data.gastos[selectedYear][selectedMonth]) {
                    APP.data.gastos[selectedYear][selectedMonth] = [];
                }

                if (APP.data.gastos[selectedYear][selectedMonth].some(item => item.concepto.toLowerCase() === concepto.trim().toLowerCase())) {
                    await showCustomAlert('Error', 'Este concepto ya existe para este mes.');
                    return;
                }
                
                APP.data.gastos[selectedYear][selectedMonth].push({ concepto: concepto.trim(), monto: "", fecha: "", pagado: "no" });
                
                if (await saveMonthData(selectedMonth, selectedYear, APP.data.gastos[selectedYear][selectedMonth])) {
                    await showCustomAlert('Éxito', 'Concepto agregado exitosamente.');
                    displayGastos();
                }
            }
        }

        async function eliminarSeleccionados() {
            const selectedCheckboxes = document.querySelectorAll('.gasto-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                await showCustomAlert('Eliminar', 'Por favor, seleccione al menos un concepto para eliminar.');
                return;
            }

            const conceptosAEliminar = Array.from(selectedCheckboxes).map(chk => chk.dataset.concepto);
            const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Está seguro de que desea eliminar los ${conceptosAEliminar.length} conceptos seleccionados de este mes?`);

            if (confirmed) {
                const selectedMonth = monthSelector.value;
                const selectedYear = yearSelector.value;

                const conceptosAEliminarSet = new Set(conceptosAEliminar);
                const gastosActuales = APP.data.gastos[selectedYear][selectedMonth];
                const nuevosGastos = gastosActuales.filter(item => !conceptosAEliminarSet.has(item.concepto));
                
                if (await saveMonthData(selectedMonth, selectedYear, nuevosGastos)) {
                    await showCustomAlert('Éxito', 'Conceptos seleccionados eliminados.');
                    displayGastos();
                }
            }
        }

        async function eliminarTodosLosMontos() {
            const confirmed = await showCustomConfirm('Confirmar', '¿Está seguro de que desea eliminar TODOS los montos y estados de pago para este mes? Los conceptos permanecerán.');
            if (confirmed) {
                const selectedMonth = monthSelector.value;
                const selectedYear = yearSelector.value;

                await displayGastos(); 

                if (!APP.data.gastos[selectedYear] || !APP.data.gastos[selectedYear][selectedMonth]) {
                    await showCustomAlert('Info', `No hay conceptos para el mes y año seleccionados.`);
                    return;
                }

                APP.data.gastos[selectedYear][selectedMonth].forEach(item => {
                    item.monto = "";
                    item.fecha = "";
                    item.pagado = "no";
                });
                if (await saveMonthData(selectedMonth, selectedYear, APP.data.gastos[selectedYear][selectedMonth])) {
                    await showCustomAlert('Éxito', 'Todos los montos eliminados para este mes.');
                    displayGastos();
                }
            }
        }

        async function exportSelectedConcepts() {
            const selectedCheckboxes = document.querySelectorAll('.gasto-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                await showCustomAlert('Exportar', 'Por favor, seleccione al menos un concepto para exportar.');
                return;
            }

            const conceptosAExportar = Array.from(selectedCheckboxes).map(chk => {
                const row = chk.closest('tr');
                const concepto = row.cells[1].textContent;
                return { concepto: concepto, monto: "", fecha: "", pagado: "no" };
            });

            const currentMonthIdx = MESES_ESPANOL.indexOf(monthSelector.value);
            let currentYear = parseInt(yearSelector.value);

            let nextMonthIdx = currentMonthIdx + 1;
            let nextYear = currentYear;

            if (nextMonthIdx >= MESES_ESPANOL.length) {
                nextMonthIdx = 0;
                nextYear++;
            }

            const nextMonthName = MESES_ESPANOL[nextMonthIdx];
            const nextYearStr = String(nextYear);

            const confirmed = await showCustomConfirm('Confirmar Exportación', 
                `¿Está seguro de exportar ${conceptosAExportar.length} concepto(s) a ${nextMonthName} de ${nextYearStr}?`
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE_URL}/data/gastos/month/${nextMonthName}/year/${nextYearStr}`);
                let targetMonthData = [];
                if (response.ok) {
                    targetMonthData = await response.json();
                } else if (response.status !== 404) {
                    throw new Error(`Error al cargar datos del mes siguiente: ${response.statusText}`);
                }

                const existingConceptsInTarget = new Set(targetMonthData.map(item => item.concepto.toLowerCase()));
                let conceptsAdded = 0;

                conceptosAExportar.forEach(concept => {
                    if (!existingConceptsInTarget.has(concept.concepto.toLowerCase())) {
                        targetMonthData.push(concept);
                        conceptsAdded++;
                    }
                });

                if (conceptsAdded > 0) {
                    if (await saveMonthData(nextMonthName, nextYearStr, targetMonthData)) {
                        await showCustomAlert('Éxito', `${conceptsAdded} concepto(s) exportado(s) exitosamente a ${nextMonthName} de ${nextYearStr}.`);
                        monthSelector.value = nextMonthName;
                        yearSelector.value = nextYearStr;
                        displayGastos();
                    }
                } else {
                    await showCustomAlert('Info', 'Todos los conceptos seleccionados ya existen en el mes siguiente.');
                }

            } catch (error) {
                console.error("Error al exportar conceptos:", error);
                await showCustomAlert('Error', `No se pudieron exportar los conceptos: ${error.message}`);
            }
        }


        return {
            init: function() {
                initializeSelectors();
                document.getElementById('gastosAddConceptoBtn').addEventListener('click', agregarConcepto);
                document.getElementById('gastosEliminarSeleccionadosBtn').addEventListener('click', eliminarSeleccionados);
                document.getElementById('gastosEliminarMontosBtn').addEventListener('click', eliminarTodosLosMontos);
                exportBtn.addEventListener('click', exportSelectedConcepts);
            },
            displayGastos: displayGastos
        };
    })();

    APP.Ingresos = (function() { // Mantenemos el nombre para no romper otras partes, pero ahora es Balance
    const tableBody = document.getElementById('balanceTableBody');
    const noItemsMessage = document.getElementById('balanceNoItemsMessage');
    const totalMontoEl = document.getElementById('balanceTotalMonto');
    const monthSelector = document.getElementById('ingresosMonthSelector');
    const yearSelector = document.getElementById('ingresosYearSelector');

    // Formulario
    const importeInput = document.getElementById('balanceImporteInput');
    const tipoSelect = document.getElementById('balanceTipoSelect');
    const conceptoInput = document.getElementById('balanceConceptoInput');
    const addBtn = document.getElementById('balanceAddBtn');
    const deleteBtn = document.getElementById('balanceDeleteBtn');

    function initializeSelectors() {
        monthSelector.innerHTML = '';
        const currentMonth = new Date().getMonth();
        MESES_ESPANOL.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            if (index === currentMonth) option.selected = true;
            monthSelector.appendChild(option);
        });
        monthSelector.addEventListener('change', displayIngresos);

        yearSelector.innerHTML = '';
        const currentYear = new Date().getFullYear();
        ANIOS.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (parseInt(year) === currentYear) option.selected = true;
            yearSelector.appendChild(option);
        });
        yearSelector.addEventListener('change', displayIngresos);
    }

    function displayIngresos() { // Renombrado internamente a displayBalance
        tableBody.innerHTML = '';
        let todosLosMovimientos = [];
        let balanceTotal = 0;

        const selectedMonth = parseInt(monthSelector.value);
        const selectedYear = parseInt(yearSelector.value);

        // 1. Cargar movimientos manuales (filtrados por mes y año)
        APP.data.ingresos.forEach(m => {
            if (!m.origen_tipo) { // Solo los que no vienen de pedidos o gastos
                const movementDate = safeParseDate(m.fecha);
                if (movementDate.getMonth() === selectedMonth && movementDate.getFullYear() === selectedYear) {
                    todosLosMovimientos.push({ ...m, tipo: m.tipo || 'ingreso', esManual: true });
                }
            }
        });

        // 2. Cargar ingresos desde pedidos entregados (filtrados por mes y año)
        APP.data.pedidos.filter(p => p.estado === 'entregado').forEach(p => {
            const pedidoDate = safeParseDate(p.fecha_entrega || p.fecha_creacion);
            if (pedidoDate && pedidoDate.getMonth() === selectedMonth && pedidoDate.getFullYear() === selectedYear) {
                todosLosMovimientos.push({
                    fecha: formatDate(pedidoDate), // Usar formatDate para un formato consistente
                    concepto: `Venta a: ${p.direccion}`,
                    tipo: 'ingreso',
                    importe: p.montoTotal,
                    esManual: false,
                    id: `pedido-${p.id}` // Añadir un ID único para evitar conflictos con movimientos manuales
                });
            }
        });

        // 3. Cargar egresos desde gastos pagados (filtrados por mes y año)
        Object.values(APP.data.gastos).forEach(yearData => {
            Object.values(yearData).forEach(monthData => {
                monthData.filter(g => g.pagado === 'si' && g.monto).forEach(g => {
                    const gastoDate = safeParseDate(g.fecha); // Formato YYYY-MM-DD
                    if (gastoDate && gastoDate.getMonth() === selectedMonth && gastoDate.getFullYear() === selectedYear) {
                        todosLosMovimientos.push({
                            fecha: formatDate(gastoDate), // Usar formatDate para un formato consistente
                            concepto: `Gasto: ${g.concepto}`,
                            tipo: 'egreso',
                            importe: parseFloat(g.monto),
                            esManual: false,
                            id: `gasto-${g.concepto}-${gastoDate.getTime()}` // ID único para gastos
                        });
                    }
                });
            });
        });

        // Ordenar por fecha
        todosLosMovimientos.sort((a, b) => {
    const dateA = safeParseDate(a.fecha);
    const dateB = safeParseDate(b.fecha);
    return (dateB ? dateB.getTime() : 0) - (dateA ? dateA.getTime() : 0);
});

        noItemsMessage.classList.toggle('hidden', todosLosMovimientos.length === 0);

        todosLosMovimientos.forEach(mov => {
            const importe = parseFloat(mov.importe);
            if (mov.tipo === 'ingreso') {
                balanceTotal += importe;
            } else {
                balanceTotal -= importe;
            }

            const row = tableBody.insertRow();
            row.className = 'table-row';
            if (mov.esManual) {
                row.classList.add('cursor-pointer');
                row.addEventListener('click', () => {
                    if (APP.selectedBalanceRow) APP.selectedBalanceRow.classList.remove('selected-row');
                    row.classList.add('selected-row');
                    APP.selectedBalanceRow = row;
                    APP.selectedBalanceData = mov;
                });
            }

            row.insertCell().textContent = formatDate(mov.fecha);
            row.insertCell().textContent = mov.concepto;

            const tipoCell = row.insertCell();
            tipoCell.textContent = mov.tipo.toUpperCase();
            tipoCell.className = mov.tipo === 'ingreso' ? 'text-green-400 font-bold' : 'text-rose-400 font-bold';

            const importeCell = row.insertCell();
            importeCell.textContent = formatCurrency(importe);
        });

        totalMontoEl.textContent = formatCurrency(balanceTotal);
        totalMontoEl.style.color = balanceTotal >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
    }


    async function addMovimientoManual() {
        const importe = parseFloat(importeInput.value);
        const tipo = tipoSelect.value;
        const concepto = conceptoInput.value.trim();

        if (isNaN(importe) || importe <= 0 || !concepto) {
            await showCustomAlert('Error', 'Por favor, ingrese un importe válido y un concepto.');
            return;
        }

        const nuevoMovimiento = {
            tipo: tipo,
            importe: importe,
            concepto: concepto,
            fecha: new Date().toISOString().split('T')[0] // YYYY-MM-DD
        };

        try {
            const response = await fetch(`${API_BASE_URL}/data/ingresos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevoMovimiento)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Error del servidor');

            APP.data.ingresos.push(result);
            displayIngresos();
            importeInput.value = '';
            conceptoInput.value = '';
        } catch (error) {
            await showCustomAlert('Error al Agregar', error.message);
        }
    }

     async function deleteMovimientoManual() {
        // Primero, nos aseguramos de que haya un movimiento manual seleccionado
        if (!APP.selectedBalanceData || !APP.selectedBalanceData.esManual) {
            await showCustomAlert('Error', 'Por favor, seleccione un movimiento manual de la tabla para poder eliminarlo.');
            return;
        }

        // Pedimos confirmación al usuario
        const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Está seguro de que desea eliminar el movimiento "${APP.selectedBalanceData.concepto}"?`);
        if (!confirmed) return;

        try {
            // Hacemos la llamada a la API para eliminar el movimiento por su ID
            const response = await fetch(`${API_BASE_URL}/data/ingresos/${APP.selectedBalanceData.id}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (!response.ok) {
                // Si hay un error, lo mostramos
                throw new Error(result.error || 'No se pudo eliminar el movimiento.');
            }

            // Si todo sale bien, actualizamos nuestros datos locales
            APP.data.ingresos = APP.data.ingresos.filter(m => m.id !== APP.selectedBalanceData.id);
            
            // Limpiamos la selección y volvemos a mostrar la tabla actualizada
            APP.selectedBalanceData = null;
            APP.selectedBalanceRow = null;
            displayIngresos();
            await showCustomAlert('Éxito', 'Movimiento manual eliminado correctamente.');

        } catch (error) {
            await showCustomAlert('Error al Eliminar', error.message);
        }
    }

    return {
        init: function() {
            initializeSelectors();
            addBtn.addEventListener('click', addMovimientoManual);
            deleteBtn.addEventListener('click', deleteMovimientoManual);
        },
        displayIngresos: displayIngresos
    };
})();
    
    APP.ListaPrecios = (function() {
        const tableBody = document.getElementById('listaPreciosTableBody');
        const noItemsMessage = document.getElementById('listaPreciosNoItemsMessage');
        const conceptoSelector = document.getElementById('listaPreciosConceptoSelector');
        const tituloSelector = document.getElementById('listaPreciosTituloSelector');
        const monthSelector = document.getElementById('listaPreciosMonthSelector');
        const yearSelector = document.getElementById('listaPreciosYearSelector');
        const addBtn = document.getElementById('listaPreciosAddBtn');
        const editBtn = document.getElementById('listaPreciosEditBtn');
        const deleteBtn = document.getElementById('listaPreciosDeleteBtn');
        const porcentajeBtn = document.getElementById('listaPreciosPorcentajeBtn');

        const editModal = document.getElementById('listaPreciosEditModal');
        const editModalTitle = document.getElementById('listaPreciosEditModalTitle');
        const editDescripcionInput = document.getElementById('listaPreciosEditDescripcionInput');
        const editCodigoInput = document.getElementById('listaPreciosEditCodigoInput');
        const editPrecioInput = document.getElementById('listaPreciosEditPrecioInput');
        const editPadreSelect = document.getElementById('listaPreciosEditPadreSelect');
        const editModalConfirmBtn = document.getElementById('listaPreciosEditModalConfirmBtn');
        const editModalCancelBtn = document.getElementById('listaPreciosEditModalCancelBtn');
        const editCodigoGroup = document.getElementById('listaPreciosEditCodigoGroup');
        const editPrecioGroup = document.getElementById('listaPreciosEditPrecioGroup');
        const editPadreGroup = document.getElementById('listaPreciosEditPadreGroup');

        const addModal = document.getElementById('listaPreciosAddModal');
        const addModalTitle = document.getElementById('listaPreciosAddModalTitle');
        const addTipoSelect = document.getElementById('listaPreciosAddTipoSelect');
        const addDescripcionInput = document.getElementById('listaPreciosAddDescripcionInput');
        const addCodigoInput = document.getElementById('listaPreciosAddCodigoInput');
        const addPrecioInput = document.getElementById('listaPreciosAddPrecioInput');
        const addPadreSelect = document.getElementById('listaPreciosAddPadreSelect');
        const addModalConfirmBtn = document.getElementById('listaPreciosAddModalConfirmBtn');
        const addModalCancelBtn = document.getElementById('listaPreciosAddModalCancelBtn');
        const addCodigoGroup = document.getElementById('listaPreciosAddCodigoGroup');
        const addPrecioGroup = document.getElementById('listaPreciosAddPrecioGroup');
        const addPadreGroup = document.getElementById('listaPreciosAddPadreGroup');

        function initializeSelectors() {
            monthSelector.innerHTML = '';
            const currentMonth = new Date().getMonth();
            MESES_ESPANOL.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthSelector.appendChild(option);
            });
            monthSelector.addEventListener('change', displayPriceList);

            yearSelector.innerHTML = '';
            const currentYear = new Date().getFullYear();
            ANIOS.forEach(year => {
                const option = document.createElement('option');
                option.value = year; 
                option.textContent = year;
                if (parseInt(year) === currentYear) option.selected = true;
                yearSelector.appendChild(option);
            });
            yearSelector.addEventListener('change', displayPriceList);
        }

        function getPriceForDate(item, targetDate) {
            if (item.tipo !== 'item' || !item.price_history || item.price_history.length === 0) return undefined;
            const validPrices = item.price_history
                .map(p => ({ ...p, dateObj: new Date(p.date) }))
                .filter(p => p.dateObj <= targetDate)
                .sort((a, b) => b.dateObj - a.dateObj);
            return validPrices.length > 0 ? validPrices[0].price : undefined;
        }

        async function fetchData() {
            try {
                const response = await fetch(`${API_BASE_URL}/data/precios`);
                if (!response.ok) throw new Error('Error al cargar la lista de precios.');
                
                const precios = await response.json();
                APP.data.precios = precios.map(item => {
                    if (item.tipo === 'item' && item.precio !== undefined && !item.price_history) {
                        item.price_history = [{ date: '2022-01-01', price: item.precio }];
                    }
                    return item;
                });

                displayPriceList();
                populateConceptoSelector();
                populateTituloSelector();
            } catch (error) {
                console.error("Error en fetchData de Lista de Precios:", error);
                await showCustomAlert("Error de Carga", `No se pudo cargar la lista de precios: ${error.message}.`);
            }
        }

        async function saveItem(item) {
            try {
                const method = APP.data.precios.some(i => i.id === item.id) ? 'PUT' : 'POST';
                const url = method === 'PUT' ? `${API_BASE_URL}/data/precios/${item.id}` : `${API_BASE_URL}/data/precios`;
                
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error del servidor.');
                return result;
            } catch (error) {
                console.error("Error al guardar ítem de precio:", error);
                await showCustomAlert("Error al Guardar", `No se pudo guardar el ítem: ${error.message}`);
                return null;
            }
        }

        function populateConceptoSelector() {
            const currentVal = conceptoSelector.value;
            conceptoSelector.innerHTML = '<option value="">Mostrar todo</option>';
            const conceptos = APP.data.precios.filter(item => item.tipo === 'concepto');
            conceptos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
            conceptos.forEach(concepto => {
                const option = document.createElement('option');
                option.value = concepto.id; option.textContent = concepto.descripcion;
                conceptoSelector.appendChild(option);
            });
            conceptoSelector.value = currentVal;
        }

        function populateTituloSelector() {
            const currentVal = tituloSelector.value;
            tituloSelector.innerHTML = '<option value="">Mostrar todo</option>';
            const titulos = APP.data.precios.filter(item => item.tipo === 'titulo');
            titulos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
            titulos.forEach(titulo => {
                const option = document.createElement('option');
                option.value = titulo.id; option.textContent = titulo.descripcion;
                tituloSelector.appendChild(option);
            });
            tituloSelector.value = currentVal;
        }

        function displayPriceList() {
            tableBody.innerHTML = '';
            APP.selectedPriceData = null;
            if (APP.selectedPriceRow) APP.selectedPriceRow.classList.remove('selected-row');

            const selectedYear = parseInt(yearSelector.value);
            const selectedMonth = parseInt(monthSelector.value);
            const targetDate = new Date(selectedYear, selectedMonth + 1, 0); 

            const selectedConceptoId = conceptoSelector.value;
            const selectedTituloId = tituloSelector.value;
            const searchInput = document.getElementById('listaPreciosSearchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            const itemMap = new Map(APP.data.precios.map(item => [item.id, { ...item, children: [] }]));
            itemMap.forEach(item => {
                if (item.padre_id && itemMap.has(item.padre_id)) {
                    itemMap.get(item.padre_id).children.push(item);
                }
            });

            let topLevelItems = Array.from(itemMap.values()).filter(item => item.tipo === 'concepto');
            
            if (selectedConceptoId) {
                const concepto = itemMap.get(selectedConceptoId);
                topLevelItems = concepto ? [concepto] : [];
            } 
            
            let itemsToRender = [];
            function flattenAndSort(nodes, level) {
                nodes.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                nodes.forEach(node => {
                    itemsToRender.push({ item: node, level: level });
                    if (node.children.length > 0) {
                        flattenAndSort(node.children, level + 1);
                    }
                });
            }
            flattenAndSort(topLevelItems, 0);

            if (selectedTituloId) {
                itemsToRender = itemsToRender.filter(renderItem => {
                    return renderItem.item.id === selectedTituloId || renderItem.item.padre_id === selectedTituloId || itemMap.get(renderItem.item.padre_id)?.padre_id === selectedTituloId;
                });
            }

            if (searchTerm) {
                // Si hay búsqueda, expandimos todo para que se vean los resultados
                // (La lógica de filtro ya está aplicada)
            } else {
                // Si NO hay búsqueda, filtramos para colapsar
                itemsToRender = itemsToRender.filter(({ item, level }) => {
                    // Mantenemos solo los items que coinciden con la búsqueda O sus padres
                    const descripcion = item.descripcion.toLowerCase();
                    const codigo = (item.codigo || '').toLowerCase();
                    
                    if (descripcion.includes(searchTerm) || codigo.includes(searchTerm)) {
                        let current = itemMap.get(item.id);
                        while (current) {
                            const parentRow = document.querySelector(`#lp-row-${current.padre_id}`);
                            if (parentRow) parentRow.dataset.expanded = 'true'; // Marcar padres para expandir
                            current = itemMap.get(current.padre_id);
                        }
                        return true;
                    }
                    return false;
                });
            }
            
            // --- INICIO: LÓGICA DE FILTRO MODIFICADA ---
            let isSearching = searchTerm.length > 0;
            if (!isSearching && selectedConceptoId) isSearching = true; // Si filtra por concepto, expandir
            if (!isSearching && selectedTituloId) isSearching = true; // Si filtra por título, expandir

            if (!isSearching) {
                itemsToRender = itemsToRender.filter(({ item }) => {
                    const descripcion = item.descripcion.toLowerCase();
                    const codigo = (item.codigo || '').toLowerCase();
                    return descripcion.includes(searchTerm) || codigo.includes(searchTerm);
                });
            }
            // --- FIN: LÓGICA DE FILTRO MODIFICADA ---


            if (itemsToRender.length === 0) { noItemsMessage.classList.remove('hidden'); return; }
            noItemsMessage.classList.add('hidden');

            itemsToRender.forEach(({ item, level }) => {
                const row = tableBody.insertRow();
                row.className = 'table-row cursor-pointer';
                row.dataset.id = item.id; 
                row.dataset.type = item.tipo;
                
                // --- INICIO: NUEVA LÓGICA DE ACORDEÓN ---
                row.dataset.level = level; // Guardamos el nivel

                // Por defecto, ocultamos todo lo que no sea nivel 0 (Concepto)
                // Si estamos buscando, mostramos todo
                if (level > 0 && !isSearching) {
                    row.classList.add('hidden');
                }
                
                // Si es un 'concepto' o 'titulo', puede ser clickeable
                if (item.tipo === 'concepto' || item.tipo === 'titulo') {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', () => {
                        let nextRow = row.nextElementSibling;
                        while (nextRow && parseInt(nextRow.dataset.level) > level) {
                            // Solo alterna la visibilidad de los hijos directos (level + 1)
                            if (parseInt(nextRow.dataset.level) === level + 1) {
                                nextRow.classList.toggle('hidden');
                            }
                            // Si un hijo estaba abierto, cerramos a sus nietos
                            if (!nextRow.classList.contains('hidden') && (item.tipo === 'concepto')) {
                                // No hacer nada, dejar que el usuario abra el siguiente nivel
                            } else {
                                // Ocultar nietos si cerramos el padre
                                let grandChild = nextRow.nextElementSibling;
                                while(grandChild && parseInt(grandChild.dataset.level) > level + 1) {
                                    grandChild.classList.add('hidden');
                                    grandChild = grandChild.nextElementSibling;
                                }
                            }
                            nextRow = nextRow.nextElementSibling;
                        }
                    });
                } else {
                     row.style.cursor = 'default'; // Los items no son clickeables
                }
                // --- FIN: NUEVA LÓGICA DE ACORDEÓN ---
                
                row.addEventListener('click', (e) => {
                    // Evitar que el click en el título también seleccione la fila (si es que interfiere)
                    if (item.tipo !== 'item') e.stopPropagation();
                    selectPriceRow(row, item);
                });


                let descText, codeText = '', priceText = '';
                let rowClasses = '';
                const indent = ' '.repeat(level * 4);

                if (item.tipo === 'item') {
                    const price = getPriceForDate(item, targetDate);
                    priceText = price !== undefined ? formatCurrency(price) : 'N/A';
                    codeText = item.codigo || '';
                    descText = `${indent}- ${item.descripcion}`;
                } else if (item.tipo === 'concepto') {
                    descText = `📄 ${item.descripcion.toUpperCase()} (+)`; // (+) indica desplegable
                    rowClasses = 'bg-gray-700 font-bold text-white';
                } else if (item.tipo === 'titulo') {
                    descText = `${indent}📁 ${item.descripcion} (+)`; // (+) indica desplegable
                    rowClasses = 'bg-gray-800 italic font-semibold';
                }

                row.className += ` ${rowClasses}`;
                row.insertCell().textContent = codeText;
                row.insertCell().textContent = descText;
                row.insertCell().textContent = priceText;
            });
        }
        function selectPriceRow(rowElement, data) {
            if (APP.selectedPriceRow) APP.selectedPriceRow.classList.remove('selected-row');
            rowElement.classList.add('selected-row');
            APP.selectedPriceRow = rowElement;
            APP.selectedPriceData = data;
        }

        async function handleEditPriceList(itemToEdit) {
            editDescripcionInput.value = ''; editCodigoInput.value = ''; editPrecioInput.value = ''; editPadreSelect.innerHTML = '';
            editModalTitle.textContent = `Editar ${itemToEdit.tipo.charAt(0).toUpperCase() + itemToEdit.tipo.slice(1)}`;
            editDescripcionInput.value = itemToEdit.descripcion;

            editCodigoGroup.classList.toggle('hidden', itemToEdit.tipo !== 'item');
            editPrecioGroup.classList.toggle('hidden', itemToEdit.tipo !== 'item');
            editPadreGroup.classList.toggle('hidden', itemToEdit.tipo === 'concepto');

            if (itemToEdit.tipo === 'titulo') {
                editPadreSelect.innerHTML = '<option value="">Seleccione un concepto</option>';
                APP.data.precios.filter(i => i.tipo === 'concepto').forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id; option.textContent = c.descripcion;
                    editPadreSelect.appendChild(option);
                });
                editPadreSelect.value = itemToEdit.padre_id;
            } else if (itemToEdit.tipo === 'item') {
                editCodigoInput.value = itemToEdit.codigo || '';
                const targetDate = new Date(parseInt(yearSelector.value), parseInt(monthSelector.value) + 1, 0);
                const currentPrice = getPriceForDate(itemToEdit, targetDate);
                editPrecioInput.value = currentPrice !== undefined ? currentPrice : '';

                editPadreSelect.innerHTML = '<option value="">Seleccione un título</option>';
                APP.data.precios.filter(i => i.tipo === 'titulo').forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id; option.textContent = t.descripcion;
                    editPadreSelect.appendChild(option);
                });
                editPadreSelect.value = itemToEdit.padre_id;
            }

            editModal.classList.add('show');

            return new Promise(resolve => {
                editModalConfirmBtn.onclick = async () => {
                    const updatedItem = { ...itemToEdit };
                    updatedItem.descripcion = editDescripcionInput.value.trim();
                    if (itemToEdit.tipo !== 'concepto') updatedItem.padre_id = editPadreSelect.value;
                    
                    if (itemToEdit.tipo === 'item') {
                        updatedItem.codigo = editCodigoInput.value.trim();
                        const newPrice = parseFloat(editPrecioInput.value);
                        if (isNaN(newPrice) || newPrice < 0) { await showCustomAlert('Error', 'El precio debe ser un número positivo.'); return; }
                        
                        const effectiveDateString = `${yearSelector.value}-${String(parseInt(monthSelector.value) + 1).padStart(2, '0')}-01`;
                        if (!updatedItem.price_history) updatedItem.price_history = [];
                        
                        const historyIndex = updatedItem.price_history.findIndex(h => h.date.startsWith(effectiveDateString.substring(0, 7)));
                        if (historyIndex > -1) updatedItem.price_history[historyIndex].price = newPrice;
                        else updatedItem.price_history.push({ date: effectiveDateString, price: newPrice });
                    }

                    if (!updatedItem.descripcion) { await showCustomAlert('Error', 'La descripción es obligatoria.'); return; }
                    if (itemToEdit.tipo !== 'concepto' && !updatedItem.padre_id) { await showCustomAlert('Error', `Seleccione un padre.`); return; }

                    const savedItem = await saveItem(updatedItem);
                    if (savedItem) {
                        const index = APP.data.precios.findIndex(i => i.id === savedItem.id);
                        if (index !== -1) APP.data.precios[index] = savedItem;
                        editModal.classList.remove('show');
                        await showCustomAlert('Éxito', 'Elemento editado exitosamente.');
                        fetchData(); resolve(true);
                    } else { resolve(false); }
                };
                editModalCancelBtn.onclick = () => { editModal.classList.remove('show'); resolve(false); };
            });
        }

        async function handleAdd() {
            addModalTitle.textContent = 'Agregar Elemento';
            addTipoSelect.value = 'concepto';
            addDescripcionInput.value = ''; addCodigoInput.value = ''; addPrecioInput.value = '';
            addPadreSelect.innerHTML = '<option value="">Seleccione un padre</option>';

            const updateAddModalFieldsVisibility = () => {
                const selectedType = addTipoSelect.value;
                addCodigoGroup.classList.toggle('hidden', selectedType !== 'item');
                addPrecioGroup.classList.toggle('hidden', selectedType !== 'item');
                addPadreGroup.classList.toggle('hidden', selectedType === 'concepto');
                addPadreSelect.innerHTML = '<option value="">Seleccione un padre</option>';
                let possibleParents = [];
                if (selectedType === 'titulo') possibleParents = APP.data.precios.filter(item => item.tipo === 'concepto');
                else if (selectedType === 'item') possibleParents = APP.data.precios.filter(item => item.tipo === 'titulo');
                possibleParents.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
                possibleParents.forEach(parent => {
                    const option = document.createElement('option');
                    option.value = parent.id; option.textContent = parent.descripcion;
                    addPadreSelect.appendChild(option);
                });
            };
            updateAddModalFieldsVisibility();
            addTipoSelect.onchange = updateAddModalFieldsVisibility;
            addModal.classList.add('show');

            return new Promise(resolve => {
                addModalConfirmBtn.onclick = async () => {
                    const itemData = {
                        id: generateUniqueId(), tipo: addTipoSelect.value, descripcion: addDescripcionInput.value.trim(),
                        codigo: addTipoSelect.value === 'item' ? addCodigoInput.value.trim() : '',
                        padre_id: addTipoSelect.value === 'concepto' ? '' : addPadreSelect.value,
                        price_history: []
                    };
                    if (!itemData.descripcion) { await showCustomAlert('Error', 'La descripción es obligatoria.'); return; }
                    if (itemData.tipo !== 'concepto' && !itemData.padre_id) { await showCustomAlert('Error', `Seleccione un padre.`); return; }

                    if (itemData.tipo === 'item') {
                        const newPrice = parseFloat(addPrecioInput.value);
                        if (isNaN(newPrice) || newPrice < 0) { await showCustomAlert('Error', 'El precio debe ser un número positivo.'); return; }
                        const effectiveDateString = `${yearSelector.value}-${String(parseInt(monthSelector.value) + 1).padStart(2, '0')}-01`;
                        itemData.price_history.push({ date: effectiveDateString, price: newPrice });
                    }

                    const savedItem = await saveItem(itemData);
                    if (savedItem) {
                        addModal.classList.remove('show');
                        await showCustomAlert('Éxito', `Elemento agregado exitosamente.`);
                        conceptoSelector.value = "";
                        tituloSelector.value = "";
                        await fetchData();
                        resolve(true);
                    } else { resolve(false); }
                };
                addModalCancelBtn.onclick = () => { addModal.classList.remove('show'); resolve(false); };
            });
        }

        async function handleDelete() {
            if (!APP.selectedPriceData) { await showCustomAlert('Eliminar', 'Por favor, seleccioná un elemento para eliminar.'); return; }
            const confirmed = await showCustomConfirm('Eliminar', `¿Estás seguro de eliminar "${APP.selectedPriceData.descripcion}"? Esto también eliminará todos sus sub-elementos.`);
            if (!confirmed) return;

            const idsToDelete = new Set();
            function collectChildren(parentId) {
                idsToDelete.add(parentId);
                APP.data.precios.filter(p => p.padre_id === parentId).forEach(child => collectChildren(child.id));
            }
            collectChildren(APP.selectedPriceData.id);

            try {
                const deletePromises = Array.from(idsToDelete).map(id => fetch(`${API_BASE_URL}/data/precios/${id}`, { method: 'DELETE' }));
                await Promise.all(deletePromises);
                await showCustomAlert("Éxito", "Elemento y sus hijos eliminados.");
            } catch (error) {
                await showCustomAlert("Error", "Fallo al eliminar un sub-elemento.");
            } finally {
                await fetchData();
            }
        }

        async function applyPercentageIncrease() {
            const percentageInput = await showCustomPrompt('Aplicar Porcentaje', 'Ingrese el porcentaje a sumar (ej: 10 para 10% o -5 para -5%):');
            if (percentageInput === null) return;

            const percentage = parseFloat(percentageInput.replace(',', '.'));
            if (isNaN(percentage)) {
                await showCustomAlert('Error', 'Porcentaje inválido. Ingrese un número válido.');
                return;
            }

            const confirmed = await showCustomConfirm('Confirmar', `¿Aplicar un cambio del ${percentage}% a TODOS los precios para el mes seleccionado? Esta acción modificará los precios existentes para este mes o creará nuevos basados en el mes anterior.`);
            if (!confirmed) return;

            const selectedYear = parseInt(yearSelector.value);
            const selectedMonth = parseInt(monthSelector.value);
            const targetDate = new Date(selectedYear, selectedMonth + 1, 0);
            const effectiveDateString = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-01`;

            const preciosActualizados = JSON.parse(JSON.stringify(APP.data.precios));
            let itemsToUpdateCount = 0;

            preciosActualizados.forEach(item => {
                if (item.tipo === 'item') {
                    const currentPriceValue = getPriceForDate(item, targetDate);

                    if (currentPriceValue !== undefined && currentPriceValue !== null) {
                        const currentPrice = parseFloat(currentPriceValue);
                        if (isNaN(currentPrice)) {
                            console.warn(`Saltando ítem ${item.descripcion} por precio inválido:`, currentPriceValue);
                            return; 
                        }

                        const newPrice = currentPrice * (1 + percentage / 100);
                        const finalNewPrice = parseFloat(newPrice.toFixed(2));

                        if (!item.price_history) {
                            item.price_history = [];
                        }

                        const historyIndex = item.price_history.findIndex(h => h.date.startsWith(effectiveDateString.substring(0, 7)));

                        if (historyIndex > -1) {
                            item.price_history[historyIndex].price = finalNewPrice;
                        } else {
                            item.price_history.push({ date: effectiveDateString, price: finalNewPrice });
                        }
                        itemsToUpdateCount++;
                    }
                }
            });

            if (itemsToUpdateCount === 0) {
                await showCustomAlert('Info', 'No se encontraron ítems con precios para actualizar.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/data/precios`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(preciosActualizados)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Error del servidor al actualizar precios.");
                }

                await showCustomAlert('Éxito', `${itemsToUpdateCount} precios han sido actualizados correctamente.`);

            } catch (error) {
                await showCustomAlert('Error Inesperado', `Hubo un problema al procesar las actualizaciones: ${error.message}`);
            } finally {
                await fetchData();
            }
        }

        async function generatePdf() {
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF || typeof jsPDF.API.autoTable !== 'function') {
                    await showCustomAlert("Error", "La librería para generar PDF no se ha cargado correctamente.");
                    return;
                }

                const selectedYear = parseInt(yearSelector.value);
                const selectedMonth = parseInt(monthSelector.value);
                const targetDate = new Date(selectedYear, selectedMonth, 1);

                const selectedConceptoId = conceptoSelector.value;
                const selectedTituloId = tituloSelector.value;
                let itemsToRender = [];
                const itemMap = new Map(APP.data.precios.map(item => [item.id, { ...item, children: [] }]));
                itemMap.forEach(item => {
                    if (item.padre_id && itemMap.has(item.padre_id)) {
                        itemMap.get(item.padre_id).children.push(item);
                    }
                });

                let topLevelItems = Array.from(itemMap.values()).filter(item => !item.padre_id || item.tipo === 'concepto');
                
                if (selectedConceptoId) {
                    const concepto = itemMap.get(selectedConceptoId);
                    topLevelItems = concepto ? [concepto] : [];
                } else if (selectedTituloId) {
                    const titulo = itemMap.get(selectedTituloId);
                    if (titulo) {
                        const padre = itemMap.get(titulo.padre_id);
                        if (padre) {
                            padre.children = [titulo];
                            topLevelItems = [padre];
                        } else {
                            topLevelItems = [titulo];
                        }
                    } else {
                        topLevelItems = [];
                    }
                }
                
                topLevelItems.sort((a, b) => a.descripcion.localeCompare(b.descripcion));

                function flattenForPdf(nodes, level) {
                    nodes.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                    nodes.forEach(node => {
                        itemsToRender.push({ item: node, level: level });
                        if (node.children.length > 0) {
                            flattenForPdf(node.children, level + 1);
                        }
                    });
                }
                flattenForPdf(topLevelItems, 0);

                if (itemsToRender.length === 0) {
                    await showCustomAlert("Info", "No hay ítems para generar el PDF.");
                    return;
                }

                const doc = new jsPDF();
                const tableBody = [];
                const rowStyles = {};
                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();

                const monthName = MESES_ESPANOL[selectedMonth];
                const year = yearSelector.value;
                const newTitle = `Lista de Precios - ${monthName} ${year}`;

                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(newTitle, pageWidth / 2, 22, { align: 'center' });

                try {
                } catch (e) {
                    console.error("Error al añadir los logos:", e);
                }
                
                itemsToRender.forEach(({ item, level }, index) => {
                    let descText, codeText, priceText;
                    let styles = {};
                    
                    if (item.tipo === 'item') {
                        const price = getPriceForDate(item, targetDate);
                        priceText = price !== undefined ? formatCurrency(price) : 'N/A';
                    }

                    if (item.tipo === 'concepto') {
                        descText = item.descripcion.toUpperCase();
                        codeText = '';
                        styles = { fontStyle: 'bold', fillColor: [55, 65, 81], textColor: [249, 250, 251] };
                    } else if (item.tipo === 'titulo') {
                        descText = ' '.repeat(level * 4) + item.descripcion;
                        codeText = '';
                        styles = { fontStyle: 'bolditalic', fillColor: [31, 41, 55], textColor: [229, 231, 235] };
                    } else {
                        descText = ' '.repeat(level * 4) + `- ${item.descripcion}`;
                        codeText = item.codigo || '';
                    }

                    tableBody.push([codeText, descText, priceText]);
                    rowStyles[index] = styles;
                });

                doc.autoTable({
                    startY: 35,
                    head: [['Código', 'Descripción', 'Precio']],
                    body: tableBody,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [128, 0, 0], // Burdeos (R, G, B)
                        textColor: [255, 255, 255], // Texto blanco para que contraste
                        fontStyle: 'bold'
                    },
                    didParseCell: function (data) {
                        if (rowStyles[data.row.index]) {
                            Object.assign(data.cell.styles, rowStyles[data.row.index]);
                        }
                    },
                    didDrawPage: function (data) {
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'italic');
                        doc.setTextColor(150);
                        const note = "Los precios no incluyen el IVA 21%";
                        doc.text(note, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    }
                });

                doc.save('lista_de_precios.pdf');
            } catch(e) {
                 console.error("Error al generar PDF:", e);
                 await showCustomAlert("Error", "Ocurrió un error inesperado al generar el PDF.");
            }
        }

        return {
            init: function() {
                initializeSelectors();
                addBtn.addEventListener('click', handleAdd);
                editBtn.addEventListener('click', () => { if (APP.selectedPriceData) handleEditPriceList(APP.selectedPriceData); else showCustomAlert('Editar', 'Por favor, seleccioná un elemento para editar.'); });
                deleteBtn.addEventListener('click', handleDelete);
                conceptoSelector.addEventListener('change', displayPriceList);
                tituloSelector.addEventListener('change', displayPriceList);
                document.getElementById('listaPreciosSearchInput').addEventListener('input', displayPriceList);
                porcentajeBtn.addEventListener('click', applyPercentageIncrease);
                document.getElementById('listaPreciosPDFBtn').addEventListener('click', generatePdf);
            },
            displayPriceList: fetchData
        };
    })();
    
        APP.Costos = (function() {
        // Referencias del Frame
        const tableBody = document.getElementById('costosTableBody');
        const noItemsMessage = document.getElementById('costosNoItemsMessage');
        const searchInput = document.getElementById('costosSearchInput');
        const editBtn = document.getElementById('costosEditBtn');

        // Referencias del Modal
        const editModal = document.getElementById('costosEditModal');
        const editModalTitle = document.getElementById('costosEditModalTitle');
        const editInfo = document.getElementById('costosEditInfo');
        const editInput = document.getElementById('costosEditInput');
        const editModalConfirmBtn = document.getElementById('costosEditModalConfirmBtn');
        const editModalCancelBtn = document.getElementById('costosEditModalCancelBtn');

        // Referencias NUEVO Modal Porcentaje
        const percentBtn = document.getElementById('costosPercentBtn');
        const percentModal = document.getElementById('costosPercentModal');
        const percentInfo = document.getElementById('costosPercentInfo');
        const percentCostoActual = document.getElementById('costosPercentCostoActual');
        const percentInput = document.getElementById('costosPercentInput');
        const percentPrecioCalculado = document.getElementById('costosPercentPrecioCalculado');
        const percentModalConfirmBtn = document.getElementById('costosPercentModalConfirmBtn');
        const percentModalCancelBtn = document.getElementById('costosPercentModalCancelBtn');

        let selectedItemData = null; // Para guardar el item seleccionado
        let selectedItemRow = null; // Para guardar la fila seleccionada

        // Función principal para mostrar la lista
        function displayCostos() {
            tableBody.innerHTML = '';
            selectedItemData = null;
            if (selectedItemRow) selectedItemRow.classList.remove('selected-row');

            const searchTerm = searchInput.value.toLowerCase().trim();
            const itemMap = new Map(APP.data.precios.map(item => [item.id, { ...item, children: [] }]));
            itemMap.forEach(item => {
                if (item.padre_id && itemMap.has(item.padre_id)) {
                    itemMap.get(item.padre_id).children.push(item);
                }
            });

            let topLevelItems = Array.from(itemMap.values()).filter(item => item.tipo === 'concepto');
            let itemsToRender = [];

            function flattenAndSort(nodes, level) {
                nodes.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                nodes.forEach(node => {
                    itemsToRender.push({ item: node, level: level });
                     if (node.children.length > 0) {
                         flattenAndSort(node.children, level + 1);
                     }
                });
            }
            flattenAndSort(topLevelItems, 0);

            let isSearching = searchTerm.length > 0;
            if (isSearching) {
                const filteredItems = new Set();
                const itemsToSearch = Array.from(itemMap.values());
                itemsToSearch.forEach(item => {
                    const descripcion = item.descripcion.toLowerCase();
                    const codigo = (item.codigo || '').toLowerCase();
                    if (descripcion.includes(searchTerm) || codigo.includes(searchTerm)) {
                        let current = item;
                        while(current) {
                            filteredItems.add(current.id);
                            current = current.padre_id ? itemMap.get(current.padre_id) : null;
                        }
                    }
                });
                itemsToRender = itemsToRender.filter(({ item }) => filteredItems.has(item.id));

                 const itemsConHijosVisibles = new Set();
                 itemsToRender.forEach(({ item }) => {
                     if (item.tipo === 'item') {
                         let current = itemMap.get(item.padre_id);
                         while(current) {
                             itemsConHijosVisibles.add(current.id);
                             current = itemMap.get(current.padre_id);
                         }
                     }
                 });
                 itemsToRender = itemsToRender.filter(({ item }) => item.tipo === 'item' || itemsConHijosVisibles.has(item.id));
             }

            noItemsMessage.classList.toggle('hidden', itemsToRender.length === 0);

            // Obtenemos la fecha actual para buscar el precio vigente
             const today = new Date(); // Usamos 'today' como targetDate constante

            itemsToRender.forEach(({ item, level }) => {
                const row = tableBody.insertRow();
                row.className = 'table-row';
                row.dataset.id = item.id;
                row.dataset.level = level;

                 if (level > 0 && !isSearching) {
                    row.classList.add('hidden');
                 }

                let descText, codigoText = '', costoText = '', percentText = ''; // <-- Nueva variable percentText
                let rowClasses = '';
                const indent = ' '.repeat(level * 4);

                if (item.tipo === 'item') {
                    row.classList.add('cursor-pointer');
                    row.addEventListener('click', () => selectCostRow(row, item));
                    descText = `${indent}- ${item.descripcion}`;
                    codigoText = item.codigo || '';
                    const costo = (item.costo !== null && item.costo !== undefined) ? parseFloat(item.costo) : null;
                    costoText = costo !== null ? formatCurrency(costo) : 'N/A';

                    // --- INICIO: CÁLCULO DE % GANANCIA ---
                    const precioActual = APP.getPriceForDate(item, today); // Usamos la función global
                    if (costo !== null && costo > 0 && precioActual !== undefined && precioActual !== null) {
                        const precio = parseFloat(precioActual);
                        if (!isNaN(precio)) {
                            const ganancia = ((precio - costo) / costo) * 100;
                            percentText = `${ganancia.toFixed(1)}%`; // Mostramos con 1 decimal
                        } else {
                            percentText = '-'; // Precio no es número válido
                        }
                    } else {
                         percentText = '-'; // No hay costo o precio
                    }
                    // --- FIN: CÁLCULO DE % GANANCIA ---

                } else if (item.tipo === 'concepto' || item.tipo === 'titulo') {
                    descText = item.tipo === 'concepto'
                        ? `📄 ${item.descripcion.toUpperCase()} (+)`
                        : `${indent}📁 ${item.descripcion} (+)`;
                    rowClasses = item.tipo === 'concepto'
                         ? 'bg-gray-700 font-bold text-white'
                         : 'bg-gray-800 italic font-semibold';
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', (e) => toggleAccordion(row, level));
                     percentText = ''; // Los títulos no tienen %
                }

                row.className += ` ${rowClasses}`;
                row.insertCell().textContent = codigoText;
                row.insertCell().textContent = descText;
                row.insertCell().textContent = costoText;
                row.insertCell().textContent = percentText; // <-- Agregamos la celda nueva
            });
        }
        
        // Función para manejar el acordeón
         function toggleAccordion(row, level) {
             let nextRow = row.nextElementSibling;
             while (nextRow && parseInt(nextRow.dataset.level) > level) {
                 // Solo alterna la visibilidad de los hijos directos (level + 1)
                 if (parseInt(nextRow.dataset.level) === level + 1) {
                     nextRow.classList.toggle('hidden');
                 } else {
                      // Si cerramos un padre, siempre ocultamos los nietos/bisnietos
                      nextRow.classList.add('hidden');
                 }
                 nextRow = nextRow.nextElementSibling;
             }
         }


        // Función para seleccionar una fila (solo items)
        function selectCostRow(rowElement, data) {
             if (data.tipo !== 'item') return; // Solo seleccionamos items
            if (selectedItemRow) {
                selectedItemRow.classList.remove('selected-row');
            }
            rowElement.classList.add('selected-row');
            selectedItemRow = rowElement;
            selectedItemData = data;
        }

        // Abrir modal para editar costo
        function openEditModal() {
            if (!selectedItemData || selectedItemData.tipo !== 'item') {
                showCustomAlert('Error', 'Por favor, seleccione un producto (no un título) para editar su costo.');
                return;
            }

            editModalTitle.textContent = `Editar Costo de ${selectedItemData.descripcion}`;
            editInfo.value = `[${selectedItemData.codigo || 'S/C'}] ${selectedItemData.descripcion}`;
            editInput.value = selectedItemData.costo !== null && selectedItemData.costo !== undefined ? selectedItemData.costo : '';
            editModal.classList.add('show');
            setTimeout(() => editInput.focus(), 100); // Foco en el input
        }

        // Guardar el costo editado
        async function handleSaveCosto() {
            const nuevoCostoStr = editInput.value.trim();
            if (nuevoCostoStr === '') {
                 await showCustomAlert('Error', 'Debe ingresar un valor para el costo.');
                 return;
            }

            const nuevoCosto = parseFloat(nuevoCostoStr.replace(',', '.')); // Permitir coma decimal

            if (isNaN(nuevoCosto) || nuevoCosto < 0) {
                await showCustomAlert('Error', 'El costo debe ser un número positivo (o cero).');
                return;
            }

            const itemToUpdate = { ...selectedItemData, costo: nuevoCosto };

            try {
                // Usamos la API de precios para actualizar, mandando solo el costo
                const response = await fetch(`${API_BASE_URL}/data/precios/${itemToUpdate.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ costo: nuevoCosto }) // Enviamos solo el campo a actualizar
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error del servidor al guardar costo.');

                // Actualizar localmente en APP.data.precios
                const index = APP.data.precios.findIndex(p => p.id === itemToUpdate.id);
                if (index !== -1) {
                    APP.data.precios[index].costo = nuevoCosto;
                }

                editModal.classList.remove('show');
                await showCustomAlert('Éxito', 'Costo actualizado correctamente.');
                displayCostos(); // Re-renderizar la lista

            } catch (error) {
                console.error("Error al guardar costo:", error);
                await showCustomAlert("Error al Guardar", `No se pudo guardar el costo: ${error.message}`);
            }
        }

        // --- NUEVO: Funciones para Modal Porcentaje ---
        function openPercentModal() {
            if (!selectedItemData || selectedItemData.tipo !== 'item') {
                showCustomAlert('Error', 'Por favor, seleccione un producto para establecer su % de ganancia.');
                return;
            }
             const costoActual = (selectedItemData.costo !== null && selectedItemData.costo !== undefined) ? parseFloat(selectedItemData.costo) : null;

             if (costoActual === null || isNaN(costoActual)) {
                 showCustomAlert('Error', 'El producto seleccionado no tiene un costo válido definido. Edite el costo primero.');
                 return;
             }

            percentInfo.value = `[${selectedItemData.codigo || 'S/C'}] ${selectedItemData.descripcion}`;
            percentCostoActual.value = formatCurrency(costoActual);
            percentInput.value = ''; // Limpiar input
            percentPrecioCalculado.value = ''; // Limpiar precio calculado

            // Listener para calcular precio en tiempo real
            percentInput.oninput = () => {
                const percent = parseFloat(percentInput.value);
                if (!isNaN(percent) && costoActual !== null) {
                    const precio = costoActual * (1 + percent / 100);
                    percentPrecioCalculado.value = formatCurrency(precio);
                } else {
                    percentPrecioCalculado.value = '';
                }
            };

            percentModal.classList.add('show');
            setTimeout(() => percentInput.focus(), 100);
        }

        async function handleSavePercent() {
            const percentStr = percentInput.value.trim();
             if (percentStr === '') {
                 await showCustomAlert('Error', 'Debe ingresar un % de ganancia.');
                 return;
             }
            const percent = parseFloat(percentStr.replace(',', '.'));
             const costoActual = parseFloat(selectedItemData.costo); // Sabemos que existe por la validación en openPercentModal

            if (isNaN(percent)) { // Permitimos 0% o negativo si el usuario quiere
                await showCustomAlert('Error', 'El porcentaje debe ser un número.');
                return;
            }

            const nuevoPrecio = costoActual * (1 + percent / 100);
            const nuevoPrecioFinal = parseFloat(nuevoPrecio.toFixed(2)); // Redondear a 2 decimales

             // --- Lógica para guardar el nuevo precio ---
             // Similar a como ListaPrecios aplica porcentaje, actualizamos/añadimos
             // la entrada en price_history para el mes/año actual.

             // Necesitamos el mes y año de ListaPrecios para saber dónde guardar
             const lpMonthSelector = document.getElementById('listaPreciosMonthSelector');
             const lpYearSelector = document.getElementById('listaPreciosYearSelector');
             const selectedYear = parseInt(lpYearSelector.value);
             const selectedMonth = parseInt(lpMonthSelector.value);
             const effectiveDateString = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-01`;

             const itemToUpdate = { ...selectedItemData }; // Copia del item
             if (!itemToUpdate.price_history) itemToUpdate.price_history = [];

             // Buscar si ya hay un precio para este mes/año
             const historyIndex = itemToUpdate.price_history.findIndex(h => h.date.startsWith(effectiveDateString.substring(0, 7)));

             if (historyIndex > -1) {
                 // Si existe, actualizarlo
                 itemToUpdate.price_history[historyIndex].price = nuevoPrecioFinal;
             } else {
                 // Si no existe, añadirlo
                 itemToUpdate.price_history.push({ date: effectiveDateString, price: nuevoPrecioFinal });
             }

             try {
                // Llamamos a la API para guardar el item COMPLETO con el historial actualizado
                 const response = await fetch(`${API_BASE_URL}/data/precios/${itemToUpdate.id}`, {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(itemToUpdate)
                 });

                 const result = await response.json();
                 if (!response.ok) throw new Error(result.error || 'Error del servidor al guardar el precio.');

                 // Actualizar localmente en APP.data.precios
                 const index = APP.data.precios.findIndex(p => p.id === itemToUpdate.id);
                 if (index !== -1) {
                     APP.data.precios[index] = result; // Usamos el resultado de la API
                 }

                 percentModal.classList.remove('show');
                 await showCustomAlert('Éxito', `Precio actualizado a ${formatCurrency(nuevoPrecioFinal)} basado en ${percent}% de ganancia.`);
                 displayCostos(); // Re-renderizar Costos
                 APP.ListaPrecios.displayPriceList(); // Re-renderizar Lista de Precios también

             } catch (error) {
                 console.error("Error al guardar precio desde porcentaje:", error);
                 await showCustomAlert("Error al Guardar", `No se pudo guardar el nuevo precio: ${error.message}`);
             }
        }

        return {
            init: function() {
                // Listener para el buscador
                searchInput.addEventListener('input', displayCostos);
                // Listener para el botón Editar
                editBtn.addEventListener('click', openEditModal);
                // Listeners para el modal
                editModalCancelBtn.addEventListener('click', () => editModal.classList.remove('show'));
                editModalConfirmBtn.addEventListener('click', handleSaveCosto);
                editInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveCosto(); });

                // NUEVO: Listeners para Modal Porcentaje (AHORA ESTÁN DENTRO)
                percentBtn.addEventListener('click', openPercentModal);
                percentModalCancelBtn.addEventListener('click', () => percentModal.classList.remove('show'));
                percentModalConfirmBtn.addEventListener('click', handleSavePercent);
                percentInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSavePercent(); });
            }, // <-- Cierre de la función init

            // La función que se llama desde showFrame
            displayCostos: displayCostos
        };
    })(); // <-- Cierre del módulo

    



    // --- INICIO: NUEVO MÓDULO DE STOCK (VERSIÓN JERÁRQUICA + BUSCADOR + CÓDIGO) ---
    APP.Stock = (function() {
        // Referencias del Frame
        const tableBody = document.getElementById('stockTableBody');
        const noItemsMessage = document.getElementById('stockNoItemsMessage');
        const addBtn = document.getElementById('stockAddBtn');
        const editBtn = document.getElementById('stockEditBtn');
        const deleteBtn = document.getElementById('stockDeleteBtn');
        const stockSearchInput = document.getElementById('stockSearchInput'); // NUEVO

        // Referencias al Modal de AGREGAR
        const addModal = document.getElementById('stockAddModal');
        const addTipoSelect = document.getElementById('stockAddTipoSelect');
        const addDescripcionInput = document.getElementById('stockAddDescripcionInput');
        const addCodigoInput = document.getElementById('stockAddCodigoInput'); // NUEVO
        const addCantidadInput = document.getElementById('stockAddCantidadInput');
        const addPadreSelect = document.getElementById('stockAddPadreSelect');
        const addModalConfirmBtn = document.getElementById('stockAddModalConfirmBtn');
        const addModalCancelBtn = document.getElementById('stockAddModalCancelBtn');
        const addCodigoGroup = document.getElementById('stockAddCodigoGroup'); // NUEVO
        const addCantidadGroup = document.getElementById('stockAddCantidadGroup');
        const addPadreGroup = document.getElementById('stockAddPadreGroup');
        
        // Referencias al Modal de EDITAR
        const editModal = document.getElementById('stockEditModal');
        const editModalTitle = document.getElementById('stockEditModalTitle');
        const editDescripcionInput = document.getElementById('stockEditDescripcionInput');
        const editCodigoInput = document.getElementById('stockEditCodigoInput'); // NUEVO
        const editCantidadInput = document.getElementById('stockEditCantidadInput');
        const editPadreSelect = document.getElementById('stockEditPadreSelect');
        const editModalConfirmBtn = document.getElementById('stockEditModalConfirmBtn');
        const editModalCancelBtn = document.getElementById('stockEditModalCancelBtn');
        const editCodigoGroup = document.getElementById('stockEditCodigoGroup'); // NUEVO
        const editCantidadGroup = document.getElementById('stockEditCantidadGroup');
        const editPadreGroup = document.getElementById('stockEditPadreGroup');


        // --- Lógica Principal de Renderizado ---
        
        async function fetchData() {
            try {
                const response = await fetch(`${API_BASE_URL}/data/stock`);
                if (!response.ok) throw new Error('Error al cargar el stock.');
                APP.data.stock = await response.json();
                renderStockList();
            } catch (error) {
                console.error("Error en fetchData de Stock:", error);
                await showCustomAlert("Error de Carga", `No se pudo cargar el stock: ${error.message}.`);
            }
        }

        function renderStockList() {
            tableBody.innerHTML = '';
            APP.selectedStockData = null;
            if (APP.selectedStockRow) APP.selectedStockRow.classList.remove('selected-row');

            // 1. Obtener término de búsqueda
            const searchTerm = stockSearchInput.value.toLowerCase().trim();

            // 2. Crear un mapa para construir la jerarquía
            const itemMap = new Map(APP.data.stock.map(item => [item.id, { ...item, children: [] }]));
            
            // 3. Llenar el array 'children' de cada padre
            itemMap.forEach(item => {
                if (item.padre_id && itemMap.has(item.padre_id)) {
                    itemMap.get(item.padre_id).children.push(item);
                }
            });

            // 4. Obtener solo los items de nivel superior (títulos)
            let topLevelItems = Array.from(itemMap.values()).filter(item => item.tipo === 'titulo');
            
            // 5. Aplanar la lista para renderizarla
            let itemsToRender = [];
            function flattenAndSort(nodes, level) {
                nodes.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                nodes.forEach(node => {
                    itemsToRender.push({ item: node, level: level });
                    if (node.children.length > 0) {
                        flattenAndSort(node.children, level + 1);
                    }
                });
            }
            flattenAndSort(topLevelItems, 0);

            // 6. Aplicar filtro de búsqueda
            let isSearching = searchTerm.length > 0;
            if (isSearching) {
                const filteredItems = new Set();
                const itemsToSearch = Array.from(itemMap.values()); 

                itemsToSearch.forEach(item => {
                    const descripcion = item.descripcion.toLowerCase();
                    const codigo = (item.codigo || '').toLowerCase();
                    if (descripcion.includes(searchTerm) || codigo.includes(searchTerm)) {
                        let current = item;
                        while(current) {
                            filteredItems.add(current.id);
                            current = current.padre_id ? itemMap.get(current.padre_id) : null;
                        }
                    }
                });
                
                itemsToRender = itemsToRender.filter(({ item }) => filteredItems.has(item.id));
            }

            // 7. Renderizar
            noItemsMessage.classList.toggle('hidden', itemsToRender.length > 0);
            
            itemsToRender.forEach(({ item, level }) => {
                const row = tableBody.insertRow();
                row.className = 'table-row cursor-pointer';
                row.dataset.id = item.id;

                // --- INICIO: NUEVA LÓGICA DE ACORDEÓN ---
                row.dataset.level = level; // Guardamos el nivel

                // Por defecto, ocultamos todo lo que no sea nivel 0 (Título)
                // Si estamos buscando, mostramos todo
                if (level > 0 && !isSearching) {
                    row.classList.add('hidden');
                }
                
                if (item.tipo === 'titulo') {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', () => {
                        let nextRow = row.nextElementSibling;
                        // Muestra/oculta todos los siguientes hasta encontrar uno del mismo nivel (o inferior)
                        while (nextRow && parseInt(nextRow.dataset.level) > level) {
                            nextRow.classList.toggle('hidden');
                            nextRow = nextRow.nextElementSibling;
                        }
                    });
                } else {
                    row.style.cursor = 'default'; // Los items no son clickeables
                }
                // --- FIN: NUEVA LÓGICA DE ACORDEÓN ---

                row.addEventListener('click', (e) => {
                    if (item.tipo !== 'producto') e.stopPropagation();
                    selectStockRow(row, item);
                });

                let descText, cantidadText = '', codigoText = '';
                let rowClasses = '';
                const indent = ' '.repeat(level * 4);

                if (item.tipo === 'producto') {
                    const cantidadNum = parseFloat(item.cantidad);
                    cantidadText = !isNaN(cantidadNum) ? cantidadNum : '';
                    descText = `${indent}- ${item.descripcion}`;
                    codigoText = item.codigo || '';
                } else if (item.tipo === 'titulo') {
                    descText = `${indent}📄 ${item.descripcion.toUpperCase()} (+)`; // (+) indica desplegable
                    rowClasses = 'bg-gray-700 font-bold text-white';
                    codigoText = '';
                }

                row.className += ` ${rowClasses}`;
                row.insertCell().textContent = codigoText;
                row.insertCell().textContent = descText;
                row.insertCell().textContent = cantidadText;
            });
        }

        function selectStockRow(rowElement, data) {
            if (APP.selectedStockRow) {
                APP.selectedStockRow.classList.remove('selected-row');
            }
            rowElement.classList.add('selected-row');
            APP.selectedStockRow = rowElement;
            APP.selectedStockData = data;
        }
        
        async function saveItem(item) {
            try {
                const method = APP.data.stock.some(i => i.id === item.id) ? 'PUT' : 'POST';
                const url = method === 'PUT' ? `${API_BASE_URL}/data/stock/${item.id}` : `${API_BASE_URL}/data/stock`;
                
                const response = await fetch(url, { 
                    method: method, 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(item) 
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error del servidor.');
                return result;
                
            } catch (error) {
                console.error("Error al guardar ítem de stock:", error);
                await showCustomAlert("Error al Guardar", `No se pudo guardar el ítem: ${error.message}`);
                return null;
            }
        }

        // --- Lógica de Modales ---

        function openAddModal() {
            addTipoSelect.value = 'titulo';
            addDescripcionInput.value = '';
            addCodigoInput.value = ''; // NUEVO
            addCantidadInput.value = '';
            
            updateAddModalFieldsVisibility(); 
            addTipoSelect.onchange = updateAddModalFieldsVisibility;
            
            addModal.classList.add('show');
        }
        
        function updateAddModalFieldsVisibility() {
            const selectedType = addTipoSelect.value;
            // Mostrar/Ocultar campos según el tipo
            addCodigoGroup.classList.toggle('hidden', selectedType !== 'producto'); // NUEVO
            addCantidadGroup.classList.toggle('hidden', selectedType !== 'producto');
            addPadreGroup.classList.toggle('hidden', selectedType !== 'producto');

            if (selectedType === 'producto') {
                // Llenar el selector de padres (solo títulos)
                addPadreSelect.innerHTML = '<option value="">Seleccione un título padre</option>';
                const titulos = APP.data.stock.filter(item => item.tipo === 'titulo');
                titulos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
                titulos.forEach(titulo => {
                    const option = document.createElement('option');
                    option.value = titulo.id; 
                    option.textContent = titulo.descripcion;
                    addPadreSelect.appendChild(option);
                });
            }
        }

        async function handleAddSave() {
            const tipo = addTipoSelect.value;
            const descripcion = addDescripcionInput.value.trim();
            const codigo = addCodigoInput.value.trim(); // NUEVO
            const cantidad = parseFloat(addCantidadInput.value);
            const padre_id = addPadreSelect.value;

            if (!descripcion) {
                await showCustomAlert('Error', 'La descripción es obligatoria.');
                return;
            }
            
            const itemData = {
                id: generateUniqueId(),
                tipo: tipo,
                descripcion: descripcion
            };

            if (tipo === 'producto') {
                if (!codigo) { // NUEVO: Validación
                    await showCustomAlert('Error', 'El código es obligatorio para un producto.');
                    return;
                }
                if (!padre_id) {
                    await showCustomAlert('Error', 'Debe seleccionar un Título padre para el producto.');
                    return;
                }
                if (isNaN(cantidad) || cantidad < 0) {
                     await showCustomAlert('Error', 'La cantidad debe ser un número positivo.');
                    return;
                }
                itemData.codigo = codigo; // NUEVO
                itemData.padre_id = padre_id;
                itemData.cantidad = cantidad;
            }

            const savedItem = await saveItem(itemData);
            if (savedItem) {
                addModal.classList.remove('show');
                await showCustomAlert('Éxito', 'Elemento agregado al stock.');
                await fetchData(); 
            }
        }
        
        function openEditModal() {
            if (!APP.selectedStockData) {
                showCustomAlert('Error', 'Por favor, seleccione un elemento para editar.');
                return;
            }
            
            const itemToEdit = APP.selectedStockData;
            
            editModalTitle.textContent = `Editar ${itemToEdit.tipo}`;
            editDescripcionInput.value = itemToEdit.descripcion;
            
            // Mostrar/Ocultar campos según el tipo
            editCodigoGroup.classList.toggle('hidden', itemToEdit.tipo !== 'producto'); // NUEVO
            editCantidadGroup.classList.toggle('hidden', itemToEdit.tipo !== 'producto');
            editPadreGroup.classList.toggle('hidden', itemToEdit.tipo !== 'producto');
            
            if (itemToEdit.tipo === 'producto') {
                editCodigoInput.value = itemToEdit.codigo || ''; // NUEVO
                editCantidadInput.value = itemToEdit.cantidad;
                
                // Llenar selector de padres (títulos)
                editPadreSelect.innerHTML = '<option value="">Seleccione un título padre</option>';
                const titulos = APP.data.stock.filter(item => item.tipo === 'titulo');
                titulos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
                titulos.forEach(titulo => {
                    const option = document.createElement('option');
                    option.value = titulo.id; 
                    option.textContent = titulo.descripcion;
                    editPadreSelect.appendChild(option);
                });
                editPadreSelect.value = itemToEdit.padre_id;
            }
            
            editModal.classList.add('show');
        }
        
        async function handleEditSave() {
            const itemToEdit = APP.selectedStockData;
            const descripcion = editDescripcionInput.value.trim();
            
            if (!descripcion) {
                await showCustomAlert('Error', 'La descripción es obligatoria.');
                return;
            }

            const updatedItem = { ...itemToEdit };
            updatedItem.descripcion = descripcion;
            
            if (itemToEdit.tipo === 'producto') {
                const codigo = editCodigoInput.value.trim(); // NUEVO
                const cantidad = parseFloat(editCantidadInput.value);
                const padre_id = editPadreSelect.value;
                
                if (!codigo) { // NUEVO: Validación
                    await showCustomAlert('Error', 'El código es obligatorio para un producto.');
                    return;
                }
                 if (!padre_id) {
                    await showCustomAlert('Error', 'Debe seleccionar un Título padre para el producto.');
                    return;
                }
                if (isNaN(cantidad) || cantidad < 0) {
                     await showCustomAlert('Error', 'La cantidad debe ser un número positivo.');
                    return;
                }
                updatedItem.codigo = codigo; // NUEVO
                updatedItem.cantidad = cantidad;
                updatedItem.padre_id = padre_id;
            }
            
            const savedItem = await saveItem(updatedItem);
            if (savedItem) {
                editModal.classList.remove('show');
                await showCustomAlert('Éxito', 'Elemento actualizado.');
                await fetchData(); 
            }
        }

        async function handleDelete() {
            if (!APP.selectedStockData) {
                await showCustomAlert('Error', 'Debe seleccionar un producto para eliminar.');
                return;
            }
            
            const item = APP.selectedStockData;
            const mensaje = item.tipo === 'titulo' 
                ? `¿Seguro que desea eliminar el título "${item.descripcion}"? TODOS los productos dentro de él también se eliminarán.`
                : `¿Seguro que desea eliminar el producto "${item.descripcion}"?`;
                
            const confirmed = await showCustomConfirm('Confirmar Eliminación', mensaje);
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE_URL}/data/stock/${item.id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'No se pudo eliminar el producto.');
                }

                await showCustomAlert('Éxito', 'Elemento eliminado del stock.');
                await fetchData(); 
                
            } catch (error) {
                await showCustomAlert('Error al Eliminar', error.message);
            }
        }

        return {
            init: function() {
                addBtn.addEventListener('click', openAddModal);
                editBtn.addEventListener('click', openEditModal);
                deleteBtn.addEventListener('click', handleDelete);
                stockSearchInput.addEventListener('input', renderStockList); // NUEVO
                
                // Listeners de modales
                addModalCancelBtn.addEventListener('click', () => addModal.classList.remove('show'));
                addModalConfirmBtn.addEventListener('click', handleAddSave);
                editModalCancelBtn.addEventListener('click', () => editModal.classList.remove('show'));
                editModalConfirmBtn.addEventListener('click', handleEditSave);
            },
            displayStock: fetchData 
        };
    })();
    // --- FIN: NUEVO MÓDULO DE STOCK ---


    // --- INICIO: NUEVO MÓDULO DE VENCIMIENTOS ---
    APP.Vencimientos = (function() {
        // Referencias del Frame
        const tableBody = document.getElementById('vencimientosTableBody');
        const noItemsMessage = document.getElementById('vencimientosNoItemsMessage');
        const addBtn = document.getElementById('vencimientosAddBtn');
        const editBtn = document.getElementById('vencimientosEditBtn');
        const deleteBtn = document.getElementById('vencimientosDeleteBtn');
        const searchInput = document.getElementById('vencimientosSearchInput');
        const alertaBox = document.getElementById('vencimientosAlertaBox');
        const alertaLista = document.getElementById('vencimientosAlertaLista');
        const vencidosAlertaBox = document.getElementById('vencimientosVencidosAlertaBox'); // <-- NUEVO
        const vencidosAlertaLista = document.getElementById('vencimientosVencidosAlertaLista');

        // Referencias al Modal de AGREGAR
        const addModal = document.getElementById('vencimientosAddModal');
        const addTipoSelect = document.getElementById('vencimientosAddTipoSelect');
        const addDescripcionInput = document.getElementById('vencimientosAddDescripcionInput');
        const addPadreSelect = document.getElementById('vencimientosAddPadreSelect');
        const addStockSelect = document.getElementById('vencimientosAddStockSelect');
        const addFechaInput = document.getElementById('vencimientosAddFechaInput');
        const addModalConfirmBtn = document.getElementById('vencimientosAddModalConfirmBtn');
        const addModalCancelBtn = document.getElementById('vencimientosAddModalCancelBtn');
        const addTituloGroup = document.getElementById('vencimientosAddTituloGroup');
        const addProductoGroup = document.getElementById('vencimientosAddProductoGroup');

        // Referencias al Modal de EDITAR
        const editModal = document.getElementById('vencimientosEditModal');
        const editModalTitle = document.getElementById('vencimientosEditModalTitle');
        const editDescripcionInput = document.getElementById('vencimientosEditDescripcionInput');
        const editPadreSelect = document.getElementById('vencimientosEditPadreSelect');
        const editProductoInfo = document.getElementById('vencimientosEditProductoInfo');
        const editFechaInput = document.getElementById('vencimientosEditFechaInput');
        const editModalConfirmBtn = document.getElementById('vencimientosEditModalConfirmBtn');
        const editModalCancelBtn = document.getElementById('vencimientosEditModalCancelBtn');
        const editTituloGroup = document.getElementById('vencimientosEditTituloGroup');
        const editProductoGroup = document.getElementById('vencimientosEditProductoGroup');
        
        async function fetchData() {
            // Ya no necesitamos un fetch separado, los datos se cargan en APP.loadInitialData()
            // Esta función solo renderizará
            renderVencimientosList();
        }

        function renderVencimientosList() {
            tableBody.innerHTML = '';
            APP.selectedVencimientoData = null; // Usamos un selector propio
            if (APP.selectedVencimientoRow) APP.selectedVencimientoRow.classList.remove('selected-row');

            // --- INICIO: LÓGICA DE ALERTA DE VENCIMIENTOS ---
        alertaLista.innerHTML = '';
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0); // Normalizar a medianoche

        const limiteFecha = new Date(hoy);
        limiteFecha.setMonth(limiteFecha.getMonth() + 2); // Fecha límite: 2 meses desde hoy

        const productosPorVencer = APP.data.vencimientos.filter(item => {
            if (item.tipo !== 'producto') return false;
            const fechaVencimiento = safeParseDate(item.vencimiento); // Usar la función global
            if (!fechaVencimiento) return false;
            
            // Que venza entre hoy y la fecha límite
            return fechaVencimiento >= hoy && fechaVencimiento <= limiteFecha;
        });

        if (productosPorVencer.length > 0) {
            // Ordenar por fecha, los más próximos primero
            productosPorVencer.sort((a, b) => safeParseDate(a.vencimiento) - safeParseDate(b.vencimiento));
            
            productosPorVencer.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `[${item.codigo}] ${item.descripcion} - Vence: ${formatDate(item.vencimiento)}`;
                alertaLista.appendChild(li);
            });
            alertaBox.classList.remove('hidden');
        } else {
            alertaBox.classList.add('hidden');
        }
        // --- FIN: LÓGICA DE ALERTA DE VENCIMIENTOS ---

        // --- INICIO: LÓGICA DE ALERTA DE VENCIDOS ---
        vencidosAlertaLista.innerHTML = '';
        // 'hoy' y 'limiteFecha' ya fueron definidos en el bloque anterior,
        // pero 'hoy' es la única que necesitamos aquí.

        const productosVencidos = APP.data.vencimientos.filter(item => {
            if (item.tipo !== 'producto') return false;
            const fechaVencimiento = safeParseDate(item.vencimiento);
            if (!fechaVencimiento) return false;
            
            // Que la fecha de vencimiento sea ANTERIOR a hoy
            return fechaVencimiento < hoy;
        });

        if (productosVencidos.length > 0) {
            // Ordenar por fecha, los más vencidos primero
            productosVencidos.sort((a, b) => safeParseDate(a.vencimiento) - safeParseDate(b.vencimiento));
            
            productosVencidos.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `[${item.codigo}] ${item.descripcion} - Venció: ${formatDate(item.vencimiento)}`;
                vencidosAlertaLista.appendChild(li);
            });
            vencidosAlertaBox.classList.remove('hidden');
        } else {
            vencidosAlertaBox.classList.add('hidden');
        }
        // --- FIN: LÓGICA DE ALERTA DE VENCIDOS ---

            const searchTerm = searchInput.value.toLowerCase().trim();
            const itemMap = new Map(APP.data.vencimientos.map(item => [item.id, { ...item, children: [] }]));
            
            itemMap.forEach(item => {
                if (item.padre_id && itemMap.has(item.padre_id)) {
                    itemMap.get(item.padre_id).children.push(item);
                }
            });

            let topLevelItems = Array.from(itemMap.values()).filter(item => item.tipo === 'titulo');
            let itemsToRender = [];
            
            function flattenAndSort(nodes, level) {
                nodes.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                nodes.forEach(node => {
                    itemsToRender.push({ item: node, level: level });
                    if (node.children.length > 0) {
                        flattenAndSort(node.children, level + 1);
                    }
                });
            }
            flattenAndSort(topLevelItems, 0);

            let isSearching = searchTerm.length > 0;
            if (isSearching) {
                const filteredItems = new Set();
                const itemsToSearch = Array.from(itemMap.values());
                itemsToSearch.forEach(item => {
                    const descripcion = item.descripcion.toLowerCase();
                    const codigo = (item.codigo || '').toLowerCase();
                    if (descripcion.includes(searchTerm) || codigo.includes(searchTerm)) {
                        let current = item;
                        while(current) {
                            filteredItems.add(current.id);
                            current = current.padre_id ? itemMap.get(current.padre_id) : null;
                        }
                    }
                });
                itemsToRender = itemsToRender.filter(({ item }) => filteredItems.has(item.id));
            }

            noItemsMessage.classList.toggle('hidden', itemsToRender.length === 0);
            
            itemsToRender.forEach(({ item, level }) => {
                const row = tableBody.insertRow();
                row.className = 'table-row cursor-pointer';
                row.dataset.id = item.id;
                row.dataset.level = level;

                if (level > 0 && !isSearching) {
                    row.classList.add('hidden');
                }
                
                if (item.tipo === 'titulo') {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', (e) => {
                        let nextRow = row.nextElementSibling;
                        while (nextRow && parseInt(nextRow.dataset.level) > level) {
                            nextRow.classList.toggle('hidden');
                            nextRow = nextRow.nextElementSibling;
                        }
                        selectVencimientoRow(row, item);
                    });
                } else {
                    row.style.cursor = 'default';
                    row.addEventListener('click', () => selectVencimientoRow(row, item));
                }

                let descText, codigoText = '', vencimientoText = '';
                let rowClasses = '';
                const indent = ' '.repeat(level * 4);

                if (item.tipo === 'producto') {
                    descText = `${indent}- ${item.descripcion}`;
                    codigoText = item.codigo || '';
                    vencimientoText = formatDate(item.vencimiento); // Usamos la función global
                } else if (item.tipo === 'titulo') {
                    descText = `${indent}📄 ${item.descripcion.toUpperCase()} (+)`;
                    rowClasses = 'bg-gray-700 font-bold text-white';
                }

                row.className += ` ${rowClasses}`;
                row.insertCell().textContent = codigoText;
                row.insertCell().textContent = descText;
                row.insertCell().textContent = vencimientoText;
            });
        }

        function selectVencimientoRow(rowElement, data) {
            if (APP.selectedVencimientoRow) {
                APP.selectedVencimientoRow.classList.remove('selected-row');
            }
            rowElement.classList.add('selected-row');
            APP.selectedVencimientoRow = rowElement;
            APP.selectedVencimientoData = data;
        }
        
        async function saveItem(item) {
            try {
                const method = APP.data.vencimientos.some(i => i.id === item.id) ? 'PUT' : 'POST';
                const url = method === 'PUT' ? `${API_BASE_URL}/data/vencimientos/${item.id}` : `${API_BASE_URL}/data/vencimientos`;
                
                const response = await fetch(url, { 
                    method: method, 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(item) 
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error del servidor.');
                
                // Recargar datos de vencimientos en el estado global
                await APP.loadInitialData();
                renderVencimientosList(); // Volver a renderizar
                
                return result;
                
            } catch (error) {
                console.error("Error al guardar ítem de vencimiento:", error);
                await showCustomAlert("Error al Guardar", `No se pudo guardar el ítem: ${error.message}`);
                return null;
            }
        }

        function openAddModal() {
            addTipoSelect.value = 'titulo';
            addDescripcionInput.value = '';
            addFechaInput.value = '';
            updateAddModalFieldsVisibility();
            addTipoSelect.onchange = updateAddModalFieldsVisibility;
            addModal.classList.add('show');
        }
        
        function updateAddModalFieldsVisibility() {
            const selectedType = addTipoSelect.value;
            addTituloGroup.classList.toggle('hidden', selectedType !== 'titulo');
            addProductoGroup.classList.toggle('hidden', selectedType !== 'producto');

            if (selectedType === 'producto') {
                // Llenar el selector de padres (Títulos de Vencimientos)
                addPadreSelect.innerHTML = '<option value="">Seleccione un título padre</option>';
                const titulos = APP.data.vencimientos.filter(item => item.tipo === 'titulo');
                titulos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
                titulos.forEach(titulo => {
                    const option = document.createElement('option');
                    option.value = titulo.id; 
                    option.textContent = titulo.descripcion;
                    addPadreSelect.appendChild(option);
                });

                // Llenar el selector de productos (del Stock)
                addStockSelect.innerHTML = '<option value="">Seleccione un producto del stock</option>';
                const stockProductos = APP.data.stock.filter(item => item.tipo === 'producto');
                stockProductos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
                stockProductos.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id; 
                    option.textContent = `[${prod.codigo}] ${prod.descripcion}`;
                    addStockSelect.appendChild(option);
                });
            }
        }

        async function handleAddSave() {
            const tipo = addTipoSelect.value;
            let itemData = {
                id: generateUniqueId(),
                tipo: tipo,
            };

            if (tipo === 'titulo') {
                const descripcion = addDescripcionInput.value.trim();
                if (!descripcion) {
                    await showCustomAlert('Error', 'La descripción del título es obligatoria.');
                    return;
                }
                itemData.descripcion = descripcion;
            } else { // Es 'producto'
                const padre_id = addPadreSelect.value;
                const stock_id = addStockSelect.value;
                const vencimiento = addFechaInput.value;

                if (!padre_id) {
                    await showCustomAlert('Error', 'Debe seleccionar un Título padre.');
                    return;
                }
                if (!stock_id) {
                    await showCustomAlert('Error', 'Debe seleccionar un Producto del stock.');
                    return;
                }
                if (!vencimiento) {
                    await showCustomAlert('Error', 'Debe ingresar una fecha de vencimiento.');
                    return;
                }
                
                const stockItem = APP.data.stock.find(s => s.id === stock_id);
                itemData.padre_id = padre_id;
                itemData.stock_id = stock_id;
                itemData.codigo = stockItem.codigo;
                itemData.descripcion = stockItem.descripcion;
                itemData.vencimiento = vencimiento;
            }

            const savedItem = await saveItem(itemData);
            if (savedItem) {
                addModal.classList.remove('show');
                await showCustomAlert('Éxito', 'Elemento agregado exitosamente.');
            }
        }
        
        function openEditModal() {
            if (!APP.selectedVencimientoData) {
                showCustomAlert('Error', 'Por favor, seleccione un elemento para editar.');
                return;
            }
            
            const itemToEdit = APP.selectedVencimientoData;
            editModalTitle.textContent = `Editar ${itemToEdit.tipo}`;
            
            editTituloGroup.classList.toggle('hidden', itemToEdit.tipo !== 'titulo');
            editProductoGroup.classList.toggle('hidden', itemToEdit.tipo !== 'producto');
            
            if (itemToEdit.tipo === 'titulo') {
                editDescripcionInput.value = itemToEdit.descripcion;
            } else { // Es 'producto'
                editFechaInput.value = itemToEdit.vencimiento;
                editProductoInfo.value = `[${itemToEdit.codigo}] ${itemToEdit.descripcion}`;
                
                editPadreSelect.innerHTML = '<option value="">Seleccione un título padre</option>';
                const titulos = APP.data.vencimientos.filter(item => item.tipo === 'titulo');
                titulos.sort((a,b) => a.descripcion.localeCompare(b.descripcion));
                titulos.forEach(titulo => {
                    const option = document.createElement('option');
                    option.value = titulo.id; 
                    option.textContent = titulo.descripcion;
                    editPadreSelect.appendChild(option);
                });
                editPadreSelect.value = itemToEdit.padre_id;
            }
            
            editModal.classList.add('show');
        }
        
        async function handleEditSave() {
            const itemToEdit = APP.selectedVencimientoData;
            const updatedItem = { ...itemToEdit };

            if (itemToEdit.tipo === 'titulo') {
                const descripcion = editDescripcionInput.value.trim();
                if (!descripcion) {
                    await showCustomAlert('Error', 'La descripción es obligatoria.');
                    return;
                }
                updatedItem.descripcion = descripcion;
            } else { // Es 'producto'
                const padre_id = editPadreSelect.value;
                const vencimiento = editFechaInput.value;
                if (!padre_id) {
                    await showCustomAlert('Error', 'Debe seleccionar un Título padre.');
                    return;
                }
                if (!vencimiento) {
                    await showCustomAlert('Error', 'Debe ingresar una fecha de vencimiento.');
                    return;
                }
                updatedItem.padre_id = padre_id;
                updatedItem.vencimiento = vencimiento;
            }
            
            const savedItem = await saveItem(updatedItem);
            if (savedItem) {
                editModal.classList.remove('show');
                await showCustomAlert('Éxito', 'Elemento actualizado.');
            }
        }

        async function handleDelete() {
            if (!APP.selectedVencimientoData) {
                await showCustomAlert('Error', 'Debe seleccionar un producto para eliminar.');
                return;
            }
            
            const item = APP.selectedVencimientoData;
            const mensaje = item.tipo === 'titulo' 
                ? `¿Seguro que desea eliminar el título "${item.descripcion}"? TODOS los productos dentro de él también se eliminarán.`
                : `¿Seguro que desea eliminar el producto "${item.descripcion}"?`;
                
            const confirmed = await showCustomConfirm('Confirmar Eliminación', mensaje);
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE_URL}/data/vencimientos/${item.id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'No se pudo eliminar el producto.');
                }
                
                await APP.loadInitialData(); // Recargar datos
                renderVencimientosList(); // Renderizar
                await showCustomAlert('Éxito', 'Elemento eliminado.');
                
            } catch (error) {
                await showCustomAlert('Error al Eliminar', error.message);
            }
        }

        return {
            init: function() {
                addBtn.addEventListener('click', openAddModal);
                editBtn.addEventListener('click', openEditModal);
                deleteBtn.addEventListener('click', handleDelete);
                searchInput.addEventListener('input', renderVencimientosList);
                
                // Listeners de modales
                addModalCancelBtn.addEventListener('click', () => addModal.classList.remove('show'));
                addModalConfirmBtn.addEventListener('click', handleAddSave);
                editModalCancelBtn.addEventListener('click', () => editModal.classList.remove('show'));
                editModalConfirmBtn.addEventListener('click', handleEditSave);
            },
            displayVencimientos: fetchData
        };
    })();
    // --- FIN: NUEVO MÓDULO DE VENCIMIENTOS ---

       // --- INICIO: NUEVO MÓDULO DE CLIENTES ---
    APP.Clientes = (function() {
        const tableBody = document.getElementById('clientesTableBody');
        const noItemsMessage = document.getElementById('clientesNoItemsMessage');

        function displayClientes() {
            tableBody.innerHTML = '';
            
            // Ordenar clientes por número
            const sortedClientes = [...APP.data.clientes].sort((a, b) => (a.numero || 0) - (b.numero || 0));

            noItemsMessage.classList.toggle('hidden', sortedClientes.length > 0);

            sortedClientes.forEach(cliente => {
                const row = tableBody.insertRow();
                row.className = 'table-row';

                let diasDesdeUltimoPedido = 'N/A';
                if (cliente.ultimo_pedido_fecha) {
                    const ultimoPedidoDate = new Date(cliente.ultimo_pedido_fecha);
                    const hoy = new Date();
                    // Ignorar la parte de la hora para el cálculo
                    ultimoPedidoDate.setHours(0, 0, 0, 0);
                    hoy.setHours(0, 0, 0, 0);
                    
                    const diffTime = Math.abs(hoy - ultimoPedidoDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    diasDesdeUltimoPedido = diffDays;
                }

                row.insertCell().textContent = cliente.numero || 'N/A';
                row.insertCell().textContent = cliente.direccion;
                row.insertCell().textContent = cliente.cantidad_pedidos || 0;
                row.insertCell().textContent = diasDesdeUltimoPedido;
            });
        }
       function renderClientes(clientes) {
            const tableBody = document.getElementById('clientesTableBody');
            tableBody.innerHTML = '';
            
            // Usamos un loop `forEach` para iterar sobre los clientes
            clientes.forEach((cliente, index) => {
                const row = document.createElement('tr');
                row.className = 'table-row cursor-pointer';
                row.dataset.id = cliente.id;
                
                // Calculamos los días desde el último pedido
                let diasDesdeUltimoPedido = 'N/A';
                if (cliente.ultima_fecha_pedido) {
                    const fechaPedido = new Date(cliente.ultima_fecha_pedido.split(' ')[0].split('/').reverse().join('-'));
                    const hoy = new Date();
                    const diffTime = Math.abs(hoy - fechaPedido);
                    diasDesdeUltimoPedido = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                }
                
                // Usamos (index + 1) para que la numeración inicie en 1
                const pedidosRealizados = cliente.pedidos_realizados || 0;
                const pedidosAnulados = cliente.pedidos_anulados || 0;
                
                row.innerHTML = `
                    <td class="table-cell">${index + 1}</td>
                    <td class="table-cell">${cliente.nombre || 'N/A'}</td>
                    <td class="table-cell">${cliente.telefono || 'N/A'}</td>
                    <td class="table-cell">${cliente.direccion || 'N/A'}</td>
                    <td class="table-cell">${pedidosRealizados}</td>
                    <td class="table-cell">${pedidosAnulados}</td>
                    <td class="table-cell">${diasDesdeUltimoPedido}</td>
                    <td class="table-cell flex gap-2 justify-center">
                        <button class="btn btn-secondary btn-sm" data-action="edit">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.25 7.25a2 2 0 01-1.414.586H3v-4.243a2 2 0 01.586-1.414l7.25-7.25zM15 4.414l-6.5 6.5-1.939 1.939L4 12.414V14h1.586l1.939-1.939 6.5-6.5z"/>
                            </svg>
                        </button>
                        <button class="btn btn-danger btn-sm" data-action="delete">
                             <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        return {
            init: function() {},
            displayClientes: displayClientes
        };
    })();
    // --- FIN: NUEVO MÓDULO DE CLIENTES ---

    // --- INICIO: MÓDULO DE PEDIDOS ACTUALIZADO ---
    APP.Pedidos = (function() {
        const monthSelector = document.getElementById('pedidosMonthSelector');
        const yearSelector = document.getElementById('pedidosYearSelector');
        const tableBody = document.getElementById('pedidosTableBody');
        const noItemsMessage = document.getElementById('pedidosNoItemsMessage');
        const addBtn = document.getElementById('pedidosAddBtn');
        const editBtn = document.getElementById('pedidosEditBtn');
        const deleteBtn = document.getElementById('pedidosDeleteBtn');

        // Modal elements
        const modal = document.getElementById('pedidosModal');
        const modalTitle = document.getElementById('pedidosModalTitle');
        const addItemSelect = document.getElementById('pedidosAddItemSelect');
        const addItemBtn = document.getElementById('pedidosAddItemBtn');
        const itemsListDiv = document.getElementById('pedidosItemsList');
        const montoTotalSpan = document.getElementById('pedidosMontoTotal');
        const direccionInput = document.getElementById('pedidosDireccionInput');
        const observacionInput = document.getElementById('pedidosObservacionInput');
        const modalConfirmBtn = document.getElementById('pedidosModalConfirmBtn');
        const modalCancelBtn = document.getElementById('pedidosModalCancelBtn');
        const clientesDatalist = document.getElementById('clientes-list'); // NUEVO

        let currentPedidoItems = [];
        let editingPedido = null;

        function initializeSelectors() {
            monthSelector.innerHTML = '';
            const currentMonth = new Date().getMonth();
            MESES_ESPANOL.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthSelector.appendChild(option);
            });
            monthSelector.addEventListener('change', displayPedidos);

            yearSelector.innerHTML = '';
            const currentYear = new Date().getFullYear();
            ANIOS.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (parseInt(year) === currentYear) option.selected = true;
                yearSelector.appendChild(option);
            });
            yearSelector.addEventListener('change', displayPedidos);
        }

        function displayPedidos() {
            tableBody.innerHTML = '';
            const selectedMonth = parseInt(monthSelector.value);
            const selectedYear = parseInt(yearSelector.value);

            const filteredPedidos = APP.data.pedidos.filter(pedido => {
                const dateToUse = pedido.fecha_creacion || pedido.id;
                const pedidoDate = new Date(dateToUse);
                return pedidoDate.getMonth() === selectedMonth && pedidoDate.getFullYear() === selectedYear;
            });

            // 1. ELIMINAMOS LA LEYENDA (comentando la línea)
            // noItemsMessage.classList.toggle('hidden', filteredPedidos.length === 0);

            const sortedPedidos = [...filteredPedidos].sort((a, b) => {
                const dateA = new Date(a.fecha_creacion || 0);
                const dateB = new Date(b.fecha_creacion || 0);
                return dateB - dateA; // Más recientes primero
            });

            // --- INICIO: NUEVA LÓGICA DE AGRUPACIÓN POR DÍA ---
            const pedidosAgrupados = {}; // Usamos un objeto para agrupar
            
            sortedPedidos.forEach(pedido => {
                // Usamos la función global formatDate para obtener un string "DD/MM/YYYY"
                const diaDelPedido = formatDate(pedido.fecha_creacion || pedido.id);
                
                if (!pedidosAgrupados[diaDelPedido]) {
                    pedidosAgrupados[diaDelPedido] = []; // Creamos un array para ese día
                }
                pedidosAgrupados[diaDelPedido].push(pedido); // Agregamos el pedido al día
            });
            // --- FIN: NUEVA LÓGICA DE AGRUPACIÓN POR DÍA ---


            // --- INICIO: BUCLE DE RENDERIZADO MODIFICADO ---
            // Ahora, en lugar de iterar sobre 'sortedPedidos', iteramos sobre los días
            Object.keys(pedidosAgrupados).forEach(dia => {
                
                // 2. Creamos la fila DIVISORA del día
                const diaRow = tableBody.insertRow();
                diaRow.className = 'bg-gray-700 font-bold'; // Un estilo para que resalte
                const diaCell = diaRow.insertCell();
                diaCell.colSpan = 4; // Hacemos que ocupe las 4 columnas
                diaCell.textContent = `--- ${dia} ---`; // Mostramos la fecha
                diaCell.style.textAlign = 'center';
                diaCell.style.padding = '8px';
                diaCell.style.color = 'var(--color-text-primary)';
                diaCell.style.letterSpacing = '1px';

                // --- INICIO: CALCULAR TOTAL DEL DÍA ---
                // Obtenemos los pedidos de este día
                const pedidosDelDia = pedidosAgrupados[dia]; 
                
                // Calculamos el total sumando el 'montoTotal' de cada pedido
                const totalDelDia = pedidosDelDia.reduce((sum, pedido) => sum + (pedido.montoTotal || 0), 0);
                // --- FIN: CALCULAR TOTAL DEL DÍA ---

                // 3. Iteramos sobre los pedidos de ESE día
                pedidosDelDia.forEach(pedido => {
                    const row = tableBody.insertRow();
                    row.className = 'table-row cursor-pointer';
                    if (pedido.estado === 'entregado') {
                        row.style.color = 'var(--color-text-muted)'; // Color gris para entregados
                    }
                    row.addEventListener('click', () => selectPedidoRow(row, pedido));
    
                    const itemsHtml = pedido.items.map(item => `<div>- [${item.codigo || 'S/C'}] ${item.descripcion} (x${item.cantidad})</div>`).join('');
                    row.insertCell().innerHTML = itemsHtml;
                    row.insertCell().textContent = formatCurrency(pedido.montoTotal || 0);
                    row.insertCell().textContent = pedido.direccion;
                    row.insertCell().textContent = pedido.observacion || 'N/A';
                });

                // --- INICIO: RENDERIZAR FILA DE TOTAL ---
                // (Este bloque AHORA SÍ está dentro del bucle 'forEach(dia => { ... })')
                const totalRow = tableBody.insertRow();
                // Le damos un estilo un poco diferente al cabezal del día
                totalRow.className = 'bg-gray-800 font-bold'; 
                
                const totalCell = totalRow.insertCell();
                totalCell.colSpan = 4; // Hacemos que ocupe las 4 columnas
                totalCell.textContent = `Total del día: ${formatCurrency(totalDelDia)}`;
                
                // Estilos para que se vea bien
                totalCell.style.textAlign = 'right'; // Alineamos a la derecha
                totalCell.style.padding = '10px 1.25rem'; // Le damos el mismo padding que las celdas
                totalCell.style.color = 'var(--color-accent)'; // Usamos tu color de acento
                totalCell.style.borderTop = '1px solid var(--color-border)'; // Un borde superior
                // --- FIN: RENDERIZAR FILA DE TOTAL ---

            }); // <-- La llave del 'Object.keys' AHORA CIERRA AQUÍ
            // --- FIN: BUCLE DE RENDERIZADO MODIFICADO ---
        }

        

        function selectPedidoRow(row, pedido) {
            if (APP.selectedPedidoRow) APP.selectedPedidoRow.classList.remove('selected-row');
            row.classList.add('selected-row');
            APP.selectedPedidoRow = row;
            APP.selectedPedidoData = pedido;
        }

        function openModal(pedido = null) {
            editingPedido = pedido;
            currentPedidoItems = pedido ? JSON.parse(JSON.stringify(pedido.items)) : [];
            modalTitle.textContent = pedido ? 'Editar Venta' : 'Agregar Venta';
            direccionInput.value = pedido ? pedido.direccion : '';
            observacionInput.value = pedido ? pedido.observacion : '';
            
            // Poblar datalist de clientes
            clientesDatalist.innerHTML = '';
            APP.data.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.direccion;
                clientesDatalist.appendChild(option);
            });

            populateItemsSelect();
            renderCurrentPedidoItems();
            modal.classList.add('show');
        }

        function populateItemsSelect() {
            addItemSelect.innerHTML = '<option value="">Seleccione un item...</option>';
            const priceItems = APP.data.precios.filter(p => p.tipo === 'item');
            priceItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                const effectivePrice = APP.getPriceForDate(item, new Date());
                option.textContent = `[${item.codigo || 'S/C'}] ${item.descripcion} - ${effectivePrice !== undefined ? formatCurrency(effectivePrice) : 'N/A'}`;
                option.dataset.price = effectivePrice;
                addItemSelect.appendChild(option);
            });
        }

        function renderCurrentPedidoItems() {
            itemsListDiv.innerHTML = '';
            let montoTotal = 0;
            if (currentPedidoItems.length === 0) {
                itemsListDiv.innerHTML = '<p class="text-gray-500 italic text-center">Añada items al pedido.</p>';
            } else {
                currentPedidoItems.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center bg-gray-800 p-1 px-2 rounded';
                    itemEl.innerHTML = `<span>[${item.codigo || 'S/C'}] ${item.descripcion} (x${item.cantidad})</span>
                  <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-400 font-bold">&times;</button>`;
                    itemsListDiv.appendChild(itemEl);
                    montoTotal += (item.precio || 0) * (item.cantidad || 1);
                });
            }
            montoTotalSpan.textContent = formatCurrency(montoTotal);
        }

        async function handleSavePedido() {
            const pedidoData = {
                items: currentPedidoItems,
                montoTotal: currentPedidoItems.reduce((sum, item) => sum + (item.precio || 0) * item.cantidad, 0),
                direccion: direccionInput.value.trim(),
                observacion: observacionInput.value.trim(),
                estado: editingPedido ? editingPedido.estado : 'pendiente',
                fecha_creacion: editingPedido ? editingPedido.fecha_creacion : new Date().toISOString(),
                fecha_entrega: editingPedido ? editingPedido.fecha_entrega : null
            };

            if (pedidoData.items.length === 0 || !pedidoData.direccion) {
                await showCustomAlert('Error', 'Debe añadir al menos un item y una dirección.');
                return;
            }

            try {
                let response, result;
                if (editingPedido) {
                    pedidoData.id = editingPedido.id;
                    response = await fetch(`${API_BASE_URL}/data/pedidos/${editingPedido.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pedidoData)
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/data/pedidos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pedidoData)
                    });
                }
                result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error del servidor');
                
                // Recargar todos los datos para asegurar consistencia entre pedidos y clientes
                await APP.loadInitialData();
                modal.classList.remove('show');
                displayPedidos();

            } catch (error) {
                await showCustomAlert('Error al Guardar', error.message);
            }
        }
        
        async function handleDeletePedido() {
            if (!APP.selectedPedidoData) {
                await showCustomAlert('Error', 'Debe seleccionar un pedido para eliminar.');
                return;
            }
            const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Seguro que desea eliminar el pedido?`);
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE_URL}/data/pedidos/${APP.selectedPedidoData.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error((await response.json()).error);
                
                await APP.loadInitialData(); // Recargar datos
                displayPedidos();
                await showCustomAlert('Éxito', 'Pedido eliminado.');

            } catch (error) {
                await showCustomAlert('Error al Eliminar', error.message);
            }
        }

        

        return {
            init: function() {
            
                initializeSelectors();
                addBtn.addEventListener('click', () => openModal());
                editBtn.addEventListener('click', () => {
                    if (APP.selectedPedidoData) openModal(APP.selectedPedidoData);
                    else showCustomAlert('Info', 'Seleccione un pedido para editar.');
                });
                deleteBtn.addEventListener('click', handleDeletePedido);

                modalCancelBtn.addEventListener('click', () => modal.classList.remove('show'));
                modalConfirmBtn.addEventListener('click', handleSavePedido);

                addItemBtn.addEventListener('click', () => {
                    const selectedOption = addItemSelect.options[addItemSelect.selectedIndex];
                    if (!selectedOption.value) return;
                    const itemId = selectedOption.value;
                    const itemPrice = parseFloat(selectedOption.dataset.price);
                    if (isNaN(itemPrice)) {
                        showCustomAlert('Error', 'El item no tiene un precio válido.');
                        return;
                    }
                    const itemData = APP.data.precios.find(p => p.id === itemId);
                    const existingItem = currentPedidoItems.find(i => i.id === itemId);
                    if (existingItem) {
                        existingItem.cantidad++;
                    } else {
                        currentPedidoItems.push({ 
    id: itemData.id,
    descripcion: itemData.descripcion,
    codigo: itemData.codigo, // <-- AGREGÁ ESTA LÍNEA
    precio: itemPrice, 
    cantidad: 1 
});
                    }
                    renderCurrentPedidoItems();
                });

                itemsListDiv.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-item-btn')) {
                        const index = e.target.dataset.index;
                        currentPedidoItems.splice(index, 1);
                        renderCurrentPedidoItems();
                    }
                });
            },
            displayPedidos: displayPedidos
        };
    })();

    
    // --- FIN: MÓDULO DE PEDIDOS ACTUALIZADO ---

   // --- INICIO: NUEVO MÓDULO DE PROVEEDORES (v2 con Buscador y Grupos) ---
APP.Proveedores = (function() {
    // Referencias a los elementos HTML
    const tableBody = document.getElementById('proveedoresTableBody');
    const noItemsMessage = document.getElementById('proveedoresNoItemsMessage');
    const excelInput = document.getElementById('proveedoresExcelInput');
    const guardarBtn = document.getElementById('proveedoresGuardarBtn');
    const searchInput = document.getElementById('proveedoresSearchInput'); // <-- NUEVO

    // Función para alternar la visibilidad de los grupos
    function toggleGrupo(grupoNombre) {
        const filas = document.querySelectorAll(`.proveedor-item-row[data-grupo="${grupoNombre}"]`);
        filas.forEach(fila => {
            fila.classList.toggle('hidden');
        });
    }

    // Esta función dibuja la tabla con los datos que tenemos
    function displayProveedores() {
        tableBody.innerHTML = '';

        if (!APP.data.proveedores) {
            APP.data.proveedores = []; // Aseguramos que sea un array
        }

        // --- 1. LÓGICA DE BÚSQUEDA ---
        const searchTerm = searchInput.value.toLowerCase().trim();
        const itemsFiltrados = APP.data.proveedores.filter(item => {
            if (!searchTerm) return true; // Si no hay búsqueda, mostrar todo
            const proveedor = (item.PROVEEDOR || '').toLowerCase();
            const codigo = (item.CODIGO || '').toString().toLowerCase();
            const descripcion = (item.DESCRIPCION || '').toLowerCase();
            return proveedor.includes(searchTerm) || 
                   codigo.includes(searchTerm) || 
                   descripcion.includes(searchTerm);
        });

        // --- 2. LÓGICA DE AGRUPACIÓN ---
        const grupos = {}; // Objeto para agrupar
        itemsFiltrados.forEach(item => {
            const grupoNombre = item.GRUPO || 'Sin Grupo';
            if (!grupos[grupoNombre]) {
                grupos[grupoNombre] = []; // Crear el array para este grupo
            }
            grupos[grupoNombre].push(item);
        });

        // --- 3. LÓGICA DE RENDERIZADO ---
        noItemsMessage.classList.toggle('hidden', itemsFiltrados.length > 0);

        const gruposOrdenados = Object.keys(grupos).sort(); // Ordenar grupos alfabéticamente

        gruposOrdenados.forEach(grupoNombre => {
            // A. Crear la Fila de TÍTULO
            const tituloRow = tableBody.insertRow();
            tituloRow.className = 'bg-gray-700 font-bold text-white cursor-pointer';
            const tituloCell = tituloRow.insertCell();
            tituloCell.colSpan = 6; // <-- AHORA SON 6 COLUMNAS
            tituloCell.textContent = `📁 ${grupoNombre.toUpperCase()} (${grupos[grupoNombre].length} items) (+)`;
            tituloCell.style.paddingLeft = '1rem';

            // Añadir el click para colapsar/expandir
            tituloRow.onclick = () => toggleGrupo(grupoNombre);

            // B. Crear las Filas de ITEMS
            grupos[grupoNombre].forEach(item => {
                const itemRow = tableBody.insertRow();
                // Ocultar items por defecto y añadir clase de grupo
                itemRow.className = 'table-row proveedor-item-row hidden'; 
                itemRow.dataset.grupo = grupoNombre; // Para que el click funcione

                itemRow.insertCell().textContent = item.PROVEEDOR || '';
                itemRow.insertCell().textContent = item.CODIGO || '';
                itemRow.insertCell().textContent = item.DESCRIPCION || '';

                // NUEVA COLUMNA COSTO
                itemRow.insertCell().textContent = formatCurrency(item.COSTO || 0); 

                const porcentaje = parseFloat(item.PORCENTAJE || 0);
                itemRow.insertCell().textContent = isNaN(porcentaje) ? '0%' : porcentaje.toFixed(2) + '%'; 
                itemRow.insertCell().textContent = formatCurrency(item.PRECIO_FINAL || 0);
            });
        });
    }

    // Esta función se activa cuando subes un archivo Excel
    async function handleExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            // Verificamos las NUEVAS columnas
            if (json.length > 0 && json[0].GRUPO !== undefined && json[0].COSTO !== undefined && json[0].PROVEEDOR !== undefined) {
                APP.data.proveedores = json; 
                displayProveedores(); 
                await showCustomAlert('Éxito', 'Archivo Excel cargado. Revisa los datos y presiona "Guardar Cambios".');
            } else {
                await showCustomAlert('Error de Formato', 'El archivo Excel no tiene las columnas esperadas (GRUPO, PROVEEDOR, CODIGO, DESCRIPCION, COSTO, PORCENTAJE, PRECIO_FINAL).');
            }

        } catch (error) {
            console.error("Error leyendo el Excel:", error);
            await showCustomAlert('Error', 'No se pudo leer el archivo de Excel.');
        }

        event.target.value = null;
    }

    // Esta función guarda los datos en el servidor (sin cambios)
    async function saveData() {
        if (!APP.data.proveedores || APP.data.proveedores.length === 0) {
            await showCustomAlert('Sin datos', 'No hay datos para guardar. Carga un Excel primero.');
            return;
        }

        const confirmed = await showCustomConfirm('Guardar Cambios', '¿Estás seguro de que deseas sobrescribir la lista de proveedores con los datos cargados?');
        if (!confirmed) return;

        try {
            const response = await fetch(`${API_BASE_URL}/data/proveedores`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(APP.data.proveedores)
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Error del servidor');

            await showCustomAlert('Éxito', 'Lista de proveedores guardada correctamente.');

        } catch (error) {
            await showCustomAlert('Error al Guardar', error.message);
        }
    }

    // Esta función conecta los botones
    return {
        init: function() {
            excelInput.addEventListener('change', handleExcelUpload);
            guardarBtn.addEventListener('click', saveData);
            searchInput.addEventListener('input', displayProveedores); // <-- AÑADIR LISTENER
        },
        displayProveedores: displayProveedores
    };
})();
// --- FIN: NUEVO MÓDULO DE PROVEEDORES (v2 con Buscador y Grupos) ---


    APP.PanelUsuarios = (function() {
        async function manageUser(action) {
            let username, password, role, welcomePhrase, body;
            const apiEndpoint = `${API_BASE_URL}/data/users`;
            const method = (action === 'create') ? 'POST' : (action === 'changePass' ? 'PUT' : 'DELETE');

            username = await showCustomPrompt(`Acción: ${action}`, "Nombre de usuario:");
            if (!username) return;

            if (action === 'create' || action === 'changePass') {
                password = await showCustomPrompt("Contraseña", `Ingrese la contraseña para ${username}:`);
                if (!password) return;
                const user = APP.data.users.find(u => u.usuario === username) || {};
                role = (action === 'create') ? (await showCustomPrompt("Rol", "admin/limitado", "limitado")) : user.rol;
                
                welcomePhrase = await showCustomPrompt("Frase de Bienvenida", `Ingrese la frase de bienvenida para ${username}:`, user.frase_bienvenida || `Bienvenido/a, ${username}`);
                if (welcomePhrase === null) return;
                
                body = { usuario: username, contrasena: password, rol: role, frase_bienvenida: welcomePhrase };
            }

            if (action === 'delete') {
                 if (username === APP.loggedInUser) {
                    await showCustomAlert("Error", "No puedes eliminar tu propia cuenta.");
                    return;
                 }
                const confirmed = await showCustomConfirm("Confirmar", `¿Eliminar al usuario ${username}?`);
                if (!confirmed) return;
            }
            
            try {
                const url = (method === 'POST') ? apiEndpoint : `${apiEndpoint}/${username}`;
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(url, options);
                
                const contentType = response.headers.get('Content-Type');
                if (contentType && !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error("Server responded with non-JSON content:", textResponse);
                    await showCustomAlert("Error de Servidor", `El servidor respondió con un formato inesperado. Mensaje: ${textResponse.substring(0, 200)}... (Ver consola para más detalles)`);
                    return;
                }

                const result = await response.json();
                if (!response.ok) throw new Error(result.error);

                await showCustomAlert("Éxito", result.message || `Operación sobre '${username}' completada.`);
                const userResponse = await fetch(apiEndpoint);
                APP.data.users = await userResponse.json();
            } catch (error) {
                console.error("Error en manageUser:", error);
                await showCustomAlert("Error", error.message || "Ocurrió un error inesperado.");
            }
        }

        return {
            init: function() {
                document.getElementById('createUserBtn').addEventListener('click', () => manageUser('create'));
                document.getElementById('changePassBtn').addEventListener('click', () => manageUser('changePass'));
                document.getElementById('deleteUserBtn').addEventListener('click', () => manageUser('delete'));
            }
        };
    })();





    
    // --- Initialize All Modules ---
    document.addEventListener('DOMContentLoaded', () => {
        setupChartDefaults();
        APP.Login.init();
        APP.Menu.init();
        APP.Inicio.init();
        APP.InicioLimitado.init();
        APP.Gastos.init();
        APP.Ingresos.init();
        APP.ListaPrecios.init();
        APP.PanelUsuarios.init();
        APP.Costos.init();
        APP.Stock.init(); // NUEVO
        APP.Vencimientos.init();
        APP.Pedidos.init();
        APP.Proveedores.init();
    });

    // --- NUEVO: Dinero en Rappi y Banco ---
async function loadRappiBanco() {
    try {
        const res = await fetch(`${API_BASE_URL}/data/rappi-banco`);
        const data = await res.json();
        document.getElementById("dashboardRappi").textContent = `$${data.rappi.toFixed(2)}`;
        document.getElementById("dashboardBanco").textContent = `$${data.banco.toFixed(2)}`;
    } catch (err) {
        console.error("Error cargando Rappi/Banco:", err);
    }
}

async function editRappiBanco() {
    try {
        const currentRappi = document.getElementById("dashboardRappi").textContent.replace("$", "") || "0";
        const currentBanco = document.getElementById("dashboardBanco").textContent.replace("$", "") || "0";

        const newRappi = await showCustomPrompt("Editar Dinero en Rappi", "Ingrese el monto actual:", currentRappi);
        if (newRappi === null) return;

        const newBanco = await showCustomPrompt("Editar Dinero en Banco", "Ingrese el monto actual:", currentBanco);
        if (newBanco === null) return;

        await fetch(`${API_BASE_URL}/data/rappi-banco`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                rappi: parseFloat(newRappi) || 0,
                banco: parseFloat(newBanco) || 0
            })
        });

        showCustomAlert("Éxito", "Datos de Rappi y Banco actualizados.");
        loadRappiBanco();
    } catch (err) {
        console.error("Error editando Rappi/Banco:", err);
    }
}

document.getElementById("editRappiBancoBtn").addEventListener("click", editRappiBanco);

// Cargar datos al entrar en Inicio
loadRappiBanco();


</script>

</body>
</html>
